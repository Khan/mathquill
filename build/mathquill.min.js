/**
 * @license
 * MathQuill v0.10.1, by Han, Jeanine, and Mary
 * http://mathquill.com | maintainers@mathquill.com
 *
 * This Source Code Form is subject to the terms of the
 * Mozilla Public License, v. 2.0. If a copy of the MPL
 * was not distributed with this file, You can obtain
 * one at http://mozilla.org/MPL/2.0/.
 */
var _a,_b,min,max,LatexCmds,CharCmds,API,EMBEDS,insistOnInterVer,MIN,MAX,saneKeyboardEvents,INCREMENTAL_SELECTION_OPEN,latexMathParser,cancelSelectionOnEdit,BuiltInOpNames,TwoWordOpNames,fn,PlusMinus,less,greater,SVG_SYMBOLS,Class,intRgx,Fraction,LiveFraction,OPP_BRACKS,BRACKET_NAMES,leftBinomialSymbol,rightBinomialSymbol;const L=-1,R=1;function noop(){}function walkUpAsFarAsPossible(e){for(;e;){if(!e.parent)return e;e=e.parent}}function pray(e,t,r){if(!t){t=new Error("prayer failed: "+e);if(r){var s,a={};for(s in t.dcgExtraErrorMetaData=a,r){var n=r[s],i=a[s]={};n?(i.localLatex=n.latex(),(n=walkUpAsFarAsPossible(n))&&(i.rootLatex=n.latex())):i.emptyNode=!0}}throw t}}function prayDirection(e){pray("a direction was passed",e===L||e===R)}function parseHTML(e){var t=document.implementation.createHTMLDocument("");if(t.body.innerHTML=e,1===t.body.children.length)return t.body.children[0];for(var r=document.createDocumentFragment();t.body.firstChild;)r.appendChild(t.body.firstChild);return r}min=Math.min,max=Math.max;const h=function(e,t,r){let s;switch(e){case"svg":case"path":s=document.createElementNS("http://www.w3.org/2000/svg",e);break;default:s=document.createElement(e)}for(const n in t){var a=t[n];void 0!==a&&s.setAttribute(n,"string"==typeof a?a:String(a))}if(r)for(let e=0;e<r.length;e++)s.appendChild(r[e]);return s};function closest(e,t){var r,s;if("function"==typeof(null==(r=e)?void 0:r.closest))return e.closest(t);if(e instanceof HTMLElement){var a=Element.prototype.matches||Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector,n=e;do{if(a.call(n,t))return n}while(null!==(n=null!=(s=null!=(s=null==n?void 0:n.parentElement)?s:null==n?void 0:n.parentNode)?s:null)&&1===n.nodeType)}return null}h.text=e=>document.createTextNode(e),h.block=(e,t,r)=>{e=h(e,t,[r.html()]);return r.setDOM(e),NodeBase.linkElementByBlockNode(e,r),e},h.entityText=e=>{e=parseHTML(e);return pray("entity parses to a single text node",e instanceof DocumentFragment&&1===e.childNodes.length&&e.childNodes[0]instanceof Text),e.childNodes[0]};const U_NO_BREAK_SPACE=" ",U_ZERO_WIDTH_SPACE="​",U_DOT_ABOVE="˙",U_NARY_SUMMATION="∑",U_NARY_PRODUCT="∏",U_NARY_COPRODUCT="∐",U_INTEGRAL="∫";function getBoundingClientRect(e){return e.getClientRects().length?e.getBoundingClientRect():{top:0,left:0,height:0,width:0,x:0,y:0,bottom:0,right:0}}function getScrollX(){return void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft}function getScrollY(){return void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop}const animate=function(){let l,d;return d="function"==typeof requestAnimationFrame&&"function"==typeof cancelAnimationFrame?(l=requestAnimationFrame,cancelAnimationFrame):(l=e=>setTimeout(e,13),clearTimeout),function(t,r){let s=Date.now(),e,a=0;function n(){var e=(Date.now()-s)/t;e<=a?o():a=e,r(a,o,i)}function i(){void 0!==e&&d(e),e=void 0}function o(){i(),e=l(n)}r(t<=0?1:0,o,i)}}();class Aria{constructor(e){this.span=h("span",{class:"mq-aria-alert","aria-live":"assertive","aria-atomic":"true"}),this.msg="",this.items=[],this.controller=e}attach(){var e=this.controller.container;this.span.parentNode!==e&&domFrag(e).prepend(domFrag(this.span))}queue(e,t=!1){var r,s="";return e instanceof MQNode?(r=e.mathspeak({ignoreShorthand:!0}),t&&(e.parent&&e.parent.ariaLabel&&"block"===e.ariaLabel?s=e.parent.ariaLabel+" "+r:e.ariaLabel&&(s=e.ariaLabel+" "+r)),""===s&&(s=r)):s=e||"",this.items.push(s),this}queueDirOf(e){return prayDirection(e),this.queue(e===L?"before":"after")}queueDirEndOf(e){return prayDirection(e),this.queue(e===L?"beginning of":"end of")}alert(e){return this.attach(),e&&this.queue(e),this.items.length&&(this.msg=this.items.join(" ").replace(/ +(?= )/g,"").trim(),this.controller.containerHasFocus())&&(this.controller.options.logAriaAlerts&&this.msg&&console.log(this.msg),this.span.textContent=this.msg),this.clear()}clear(){return this.items.length=0,this}}class DOMFragment{constructor(e,t){1===arguments.length&&(t=e),e&&t&&(this.ends={[L]:e,[R]:t})}static create(e,t){pray("No half-empty DOMFragments",!!e==!!(t=1===arguments.length?e:t));e=new DOMFragment(e,t);return pray("last is a forward sibling of first",e.isValid()),e}isEmpty(){return void 0===this.ends}isOneNode(){return!(!this.ends||this.ends[L]!==this.ends[R])}isValid(){if(!this.ends)return!0;if(this.ends[L]===this.ends[R])return!0;let t;return this.eachNode(e=>t=e),t===this.ends[R]}firstNode(){return pray("Fragment is not empty",this.ends),this.ends[L]}lastNode(){return pray("Fragment is not empty",this.ends),this.ends[R]}children(){var e=this.oneNode(),t=e.firstChild,e=e.lastChild;return t&&e?new DOMFragment(t,e):new DOMFragment}join(e){if(!this.ends)return e;if(!e.ends)return this;let t=!1,r=this.ends[R].nextSibling;for(;r;){if(r===e.ends[L]){t=!0;break}r=r.nextSibling}return pray("sibling must be a forward DOM sibling of this fragment",t),new DOMFragment(this.ends[L],e.ends[R])}oneNode(){return pray("Fragment has a single node",this.ends&&this.ends[L]===this.ends[R]),this.ends[L]}oneElement(){var e=this.oneNode();return pray("Node is an Element",e.nodeType===Node.ELEMENT_NODE),e}oneText(){var e=this.oneNode();return pray("Node is Text",e.nodeType===Node.TEXT_NODE),e}eachNode(r){if(this.ends){var s=this.ends[R];for(let e=this.ends[L],t;e&&(t=e.nextSibling,r(e),e!==s);e=t);}return this}eachElement(t){return this.eachNode(e=>{e.nodeType===Node.ELEMENT_NODE&&t(e)}),this}text(){let t="";return this.eachNode(e=>{t+=e.textContent||""}),t}toNodeArray(){const t=[];return this.eachNode(e=>t.push(e)),t}toElementArray(){const t=[];return this.eachElement(e=>t.push(e)),t}toDocumentFragment(){const t=document.createDocumentFragment();return this.eachNode(e=>t.appendChild(e)),t}insertBefore(e){return this.insDirOf(L,e)}insertAfter(e){return this.insDirOf(R,e)}append(e){return e.appendTo(this.oneElement()),this}prepend(e){return e.prependTo(this.oneElement()),this}appendTo(e){return this.insAtDirEnd(R,e)}prependTo(e){return this.insAtDirEnd(L,e)}parent(){var e;return this.ends?(e=this.ends[L].parentNode)?new DOMFragment(e):new DOMFragment:this}wrapAll(e){var t,r;return e.textContent="",this.ends&&(t=this.ends[L].parentNode,r=this.ends[R].nextSibling,this.appendTo(e),t)&&t.insertBefore(e,r),this}replaceWith(e){var t=null==(t=this.ends)?void 0:t[R],r=null==t?void 0:t.parentNode,s=null==t?void 0:t.nextSibling,e=(this.detach(),e.toDocumentFragment());return t&&r&&r.insertBefore(e,s||null),this}nthElement(t){if(this.ends&&!(t<0||t!==Math.floor(t))){let e=this.ends[L];for(;e;){if(e.nodeType===Node.ELEMENT_NODE){if(t<=0)return e;--t}if(e===this.ends[R])return;e=e.nextSibling}}}firstElement(){return this.nthElement(0)}lastElement(){if(this.ends){let e=this.ends[R];for(;e;){if(e.nodeType===Node.ELEMENT_NODE)return e;if(e===this.ends[L])return;e=e.previousSibling}}}first(){return new DOMFragment(this.firstElement())}last(){return new DOMFragment(this.lastElement())}eq(e){return new DOMFragment(this.nthElement(e))}slice(e){return this.ends?(e=this.nthElement(e))?new DOMFragment(e,this.ends[R]):new DOMFragment:this}next(){let e=this.oneNode();for(;e;)if((e=e.nextSibling)&&e.nodeType===Node.ELEMENT_NODE)return new DOMFragment(e);return new DOMFragment}prev(){let e=this.oneNode();for(;e;)if((e=e.previousSibling)&&e.nodeType===Node.ELEMENT_NODE)return new DOMFragment(e);return new DOMFragment}empty(){return this.eachElement(e=>{e.textContent=""}),this}remove(){return this.toDocumentFragment(),this}detach(){return this.remove()}insDirOf(e,t){if(this.ends){t=null==(t=t.ends)?void 0:t[e];if(!t||!t.parentNode)return this.detach();_insDirOf(e,t.parentNode,this.toDocumentFragment(),t)}return this}insAtDirEnd(e,t){return this.ends&&_insAtDirEnd(e,this.toDocumentFragment(),t),this}hasClass(t){let r=!1;return this.eachElement(e=>{e.classList.contains(t)&&(r=!0)}),r}addClass(e){for(const t of e.split(/\s+/))t&&this.eachElement(e=>{e.classList.add(t)});return this}removeClass(e){for(const t of e.split(/\s+/))t&&this.eachElement(e=>{e.classList.remove(t)});return this}toggleClass(e,t){if(!0===t)return this.addClass(e);if(!1===t)return this.removeClass(e);for(const r of e.split(/\s+/))r&&this.eachElement(e=>{e.classList.toggle(r)});return this}}const domFrag=DOMFragment.create;function _insDirOf(e,t,r,s){t.insertBefore(r,e===L?s:s.nextSibling)}function _insAtDirEnd(e,t,r){e===L?r.insertBefore(t,r.firstChild):r.appendChild(t)}class Point{constructor(e,t,r){this.init(e,t,r)}init(e,t,r){this.parent=e,this[L]=t,this[R]=r}static copy(e){return new Point(e.parent,e[L],e[R])}}function eachNode(e,t){var r,s=e[L];if(s&&(r=e[R]))for(r=r[R];s!==r&&!1!==t(s);s=s[R]);}function foldNodes(e,t,r){var s,a=e[L];if(a&&(s=e[R]))for(s=s[R];a!==s;a=a[R])t=r(t,a);return t}class NodeBase{constructor(){this[_a]=0,this[_b]=0,this.parent=0,this.ends={[L]:0,[R]:0},this.id=NodeBase.uniqueNodeId()}static uniqueNodeId(){return NodeBase.idCounter+=1}static getNodeOfElement(e){if(e){if(e.nodeType)return e.mqBlockNode||e.mqCmdNode;throw new Error("must pass an Element to NodeBase.getNodeOfElement")}}static linkElementByBlockNode(e,t){e.mqBlockNode=t}static linkElementByCmdNode(e,t){e.mqCmdNode=t}setEnds(e){this.ends=e,pray("No half-empty node ends",!!this.ends[L]==!!this.ends[R])}getEnd(e){return this.ends[e]}toString(){return"{{ MathQuill Node #"+this.id+" }}"}setDOM(e){return e&&pray("DOM is an element or a text node",e.nodeType===Node.ELEMENT_NODE||e.nodeType===Node.TEXT_NODE),this._el=e,this}domFrag(){return domFrag(this._el)}createDir(e,t){prayDirection(e);return this.html(),this.domFrag().insDirOf(e,t.domFrag()),t[e]=this.adopt(t.parent,t[L],t[R]),this}createLeftOf(e){this.createDir(L,e)}selectChildren(e,t){return new MQSelection(e,t)}bubble(e){for(var t=this.getSelfNode();t&&!1!==e(t);t=t.parent);return this}postOrder(r){var e=this.getSelfNode();return function e(t){return!!t&&(t.eachChild(e),r(t),!0)}(e),e}isEmpty(){return 0===this.ends[L]&&0===this.ends[R]}isQuietEmptyDelimiter(e){var t;return!!this.isEmpty()&&!!e&&!(!this.parent||void 0===this.parent.ctrlSeq)&&(t=this.parent.ctrlSeq.replace(/^\\(left|right)?/,""),e.hasOwnProperty(t))}isStyleBlock(){return!1}isTextBlock(){return!1}children(){return new Fragment(this.getEnd(L),this.getEnd(R))}eachChild(e){return eachNode(this.ends,e),this}foldChildren(e,t){return foldNodes(this.ends,e,t)}withDirAdopt(e,t,r,s){var a=this.getSelfNode();return new Fragment(a,a).withDirAdopt(e,t,r,s),this}adopt(e,t,r){var s=this.getSelfNode();return new Fragment(s,s).adopt(e,t,r),this.getSelfNode()}disown(){var e=this.getSelfNode();return new Fragment(e,e).disown(),this}remove(){return this.domFrag().remove(),this.disown()}shouldIgnoreSubstitutionInSimpleSubscript(e){return!!e.disableAutoSubstitutionInSubscripts&&!!this.parent&&this.parent.parent instanceof SupSub&&!!this.parent.domFrag().hasClass("mq-sub")}getSelfNode(){return this}parser(){pray("Abstract parser() method is never called",!1)}html(){throw new Error("html() unimplemented in NodeBase")}text(){return""}latex(){var e={latex:"",startIndex:-1,endIndex:-1};return this.latexRecursive(e),e.latex}latexRecursive(e){}checkCursorContextOpen(e){e.startSelectionBefore===this&&(e.startIndex=e.latex.length),e.endSelectionBefore===this&&(e.endIndex=e.latex.length)}checkCursorContextClose(e){e.startSelectionAfter===this&&(e.startIndex=e.latex.length),e.endSelectionAfter===this&&(e.endIndex=e.latex.length)}finalizeTree(e,t){}contactWeld(e,t){}blur(e){}focus(){}intentionalBlur(){}reflow(){}registerInnerField(e,t){}chToCmd(e,t){pray("Abstract chToCmd() method is never called",!1)}mathspeak(e){return""}seek(e,t){}siblingDeleted(e,t){}siblingCreated(e,t){}finalizeInsert(e,t){}fixDigitGrouping(e){}writeLatex(e,t){}write(e,t){}}function prayWellFormed(e,t,r){pray("a parent is always present",e),pray("leftward is properly set up",t?t[R]===r&&t.parent===e:e.getEnd(L)===r,{parent:e,leftward:t,leftwardL:t&&t[L],leftwardR:t&&t[R],rightwardL:r&&r[L],rightwardR:r&&r[R]}),pray("rightward is properly set up",r?r[L]===t&&r.parent===e:e.getEnd(R)===t,{parent:e,rightward:r,leftwardL:t&&t[L],leftwardR:t&&t[R],rightwardL:r&&r[L],rightwardR:r&&r[R],rightwardParent:r&&r.parent})}_a=L,_b=R,NodeBase.idCounter=0;class Fragment{constructor(e,r,s){if(this.disowned=!1,prayDirection(s=void 0===s?L:s),pray("no half-empty fragments",!e==!r,{withDir:e,oppDir:r}),e&&r){pray("withDir is passed to Fragment",e instanceof MQNode),pray("oppDir is passed to Fragment",r instanceof MQNode),pray("withDir and oppDir have the same parent",e.parent===r.parent);e={[s]:e,[-s]:r};this.setEnds(e);let t=0;this.each(e=>{t=e}),pray("following direction siblings from start reaches end",t===e[R])}else this.setEnds({[L]:0,[R]:0})}getDOMFragFromEnds(){var e=this.ends[L],t=this.ends[R];return 0===e||0===t?domFrag():e===t?e.domFrag():e.domFrag().join(t.domFrag())}setEnds(e){this.ends=e}getEnd(e){return this.ends?this.ends[e]:0}domFrag(){return this.getDOMFragFromEnds()}withDirAdopt(e,t,r,s){return e===L?this.adopt(t,r,s):this.adopt(t,s,r)}adopt(t,r,e){var s,a,n;return prayWellFormed(t,r,e),this.disowned=!1,(s=this.ends[L])&&(a=this.ends[R])&&(n={[L]:t.getEnd(L),[R]:t.getEnd(R)},r||(n[L]=s),e?e[L]=a:n[R]=a,t.setEnds(n),a[R]=e,this.each(function(e){return e[L]=r,e.parent=t,r&&(r[R]=e),r=e,!0})),this}disown(){var e,t,r,s=this,a=s.ends[L];return a&&!s.disowned&&(this.disowned=!0,e=s.ends[R])&&(prayWellFormed(t=a.parent,a[L],a),prayWellFormed(t,e,e[R]),r={[L]:t.getEnd(L),[R]:t.getEnd(R)},a[L]?a[L][R]=e[R]:r[L]=e[R],e[R]?e[R][L]=a[L]:r[R]=a[L],r[L]&&r[R]?t.setEnds(r):t.ends=r),s}remove(){return this.domFrag().remove(),this.disown()}each(e){return eachNode(this.ends,e),this}fold(e,t){return foldNodes(this.ends,e,t)}}function isMQNodeClass(e){return e&&e.prototype instanceof MQNode}LatexCmds={},CharCmds={};class Anticursor extends Point{constructor(e,t,r){super(e,t,r),this.ancestors={}}static fromCursor(e){return new Anticursor(e.parent,e[L],e[R])}}class Cursor extends Point{constructor(e,t,r){super(e,0,0),this.upDownCache={},this.cursorElement=h("span",{class:"mq-cursor"},[h.text(U_ZERO_WIDTH_SPACE)]),this._domFrag=domFrag(),this.controller=r,this.options=t,this.setDOMFrag(domFrag(this.cursorElement)),this.blink=()=>{domFrag(this.cursorElement).toggleClass("mq-blink")}}setDOMFrag(e){return this._domFrag=e,this}domFrag(){return this._domFrag}show(){var e,t;return domFrag(this.cursorElement).removeClass("mq-blink"),this.setDOMFrag(domFrag(this.cursorElement)),this.intervalId?clearInterval(this.intervalId):((e=this[R])?(t=this.selection)&&t.getEnd(L)[L]===this[L]?this.domFrag().insertBefore(t.domFrag()):this.domFrag().insertBefore(e.domFrag()):this.domFrag().appendTo(this.parent.domFrag().oneElement()),this.parent.focus()),this.intervalId=setInterval(this.blink,500),this}hide(){return this.intervalId&&clearInterval(this.intervalId),this.intervalId=0,this.domFrag().detach(),this.setDOMFrag(domFrag()),this}withDirInsertAt(e,t,r,s){var a=this.parent;this.parent=t,this[e]=r,this[-e]=s,a!==t&&a.blur&&a.blur(this)}insDirOf(e,t){return prayDirection(e),this.domFrag().insDirOf(e,t.domFrag()),this.withDirInsertAt(e,t.parent,t[e],t),this.parent.domFrag().addClass("mq-hasCursor"),this}insLeftOf(e){return this.insDirOf(L,e)}insRightOf(e){return this.insDirOf(R,e)}insAtDirEnd(e,t){return prayDirection(e),this.domFrag().insAtDirEnd(e,t.domFrag().oneElement()),this.withDirInsertAt(e,t,0,t.getEnd(e)),t.focus(),this}insAtLeftEnd(e){return this.insAtDirEnd(L,e)}insAtRightEnd(e){return this.insAtDirEnd(R,e)}jumpUpDown(e,t){var r,s=this;s.upDownCache[e.id]=Point.copy(s),(e=s.upDownCache[t.id])?(r=e[R])?s.insLeftOf(r):s.insAtRightEnd(e.parent):(r=s.getBoundingClientRectWithoutMargin().left,t.seek(r,s)),s.controller.aria.queue(t,!0)}getBoundingClientRectWithoutMargin(){var e=this.domFrag(),{left:t,right:r}=(e.removeClass("mq-cursor"),getBoundingClientRect(e.oneElement()));return e.addClass("mq-cursor"),{left:t,right:r}}unwrapGramp(){var e,t,r,s=this.parent.parent,a=s.parent,n=s[R],i=s[L];if(s.disown().eachChild(function(e){return e.isEmpty()||(e.children().adopt(a,i,n).each(function(e){return e.domFrag().insertBefore(s.domFrag()),!0}),i=e.getEnd(R)),!0}),!this[R])if(t=this[L])this[R]=t[R];else for(;!this[R];){if(!(e=this.parent[R])){this[R]=s[R],this.parent=a;break}this.parent=e,this[R]=e.getEnd(L)}(t=this[R])?this.insLeftOf(t):this.insAtRightEnd(a),s.domFrag().remove(),t=s[L],r=s[R],t&&t.siblingDeleted(this.options,R),r&&r.siblingDeleted(this.options,L)}startSelection(){for(var e=this.anticursor=Anticursor.fromCursor(this),t=e.ancestors,r=e;r.parent;r=r.parent)t[r.parent.id]=r}endSelection(){delete this.anticursor}select(){var e,t,r,s,a,n,i,o,l=this.anticursor;if(this[L]===l[L]&&this.parent===l.parent)return!1;for(t=this;t.parent;t=t.parent)if(t.parent.id in l.ancestors){e=t.parent;break}if(pray("cursor and anticursor in the same tree",e),o=e,r=l.ancestors[o.id],n=R,t[L]!==r)for(i=t;i;i=i[R])if(i[R]===r[R]){n=L,s=t,a=r;break}return n===R&&(s=r,a=t),s instanceof Point&&(s=s[R]),a instanceof Point&&(a=a[L]),this.hide().selection=o.selectChildren(s,a),o=this.selection.getEnd(n),this.insDirOf(n,o),this.selectionChanged(),!0}resetToEnd(e){this.clearSelection();e=e.root;this[R]=0,this[L]=e.getEnd(R),this.parent=e}clearSelection(){return this.selection&&(this.selection.clear(),delete this.selection,this.selectionChanged()),this}deleteSelection(){var e=this.selection;e&&(this[L]=e.getEnd(L)[L],this[R]=e.getEnd(R)[R],e.remove(),this.selectionChanged(),delete this.selection)}replaceSelection(){var e=this.selection;return e&&(this[L]=e.getEnd(L)[L],this[R]=e.getEnd(R)[R],delete this.selection),e}depth(){for(var e=this,t=0;e=e.parent;)t+=e instanceof MathBlock?1:0;return t}isTooDeep(e){return void 0!==this.options.maxDepth&&this.depth()+(e||0)>this.options.maxDepth}selectionChanged(){}}class MQSelection extends Fragment{constructor(e,t,r){super(e,t,r),this._el=h("span",{class:"mq-selection"}),this.getDOMFragFromEnds().wrapAll(this._el)}isCleared(){return void 0===this._el}domFrag(){return this.isCleared()?this.getDOMFragFromEnds():domFrag(this._el)}setEnds(e){pray("Selection ends are never empty",e[L]&&e[R]),this.ends=e}getEnd(e){return this.ends[e]}adopt(e,t,r){return this.clear(),super.adopt(e,t,r)}clear(){var e=this.getDOMFragFromEnds();return this.domFrag().replaceWith(e),this._el=void 0,this}join(r,s=""){return this.fold("",function(e,t){return e+s+t[r]()})}}class ControllerBase{constructor(e,t,r){this.textareaEventListeners={},this.id=e.id,this.data={},this.root=e,this.container=t,this.options=r,this.aria=new Aria(this.getControllerSelf()),this.ariaLabel="Math Input",this.ariaPostLabel="",e.controller=this.getControllerSelf(),this.cursor=e.cursor=new Cursor(e,r,this.getControllerSelf())}getControllerSelf(){return this}handle(e,t){var r=this.options.handlers,s=null==(s=this.options.handlers)?void 0:s.fns[e];s&&(pray("APIClass is defined",e=null==r?void 0:r.APIClasses[this.KIND_OF_MQ]),r=new e(this),t===L||t===R?s(t,r):s(r))}static onNotify(e){ControllerBase.notifyees.push(e)}notify(e){for(var t=0;t<ControllerBase.notifyees.length;t+=1)ControllerBase.notifyees[t](this.cursor,e);return this}setAriaLabel(e){var t=this.getAriaLabel();return e&&"string"==typeof e&&""!==e?this.ariaLabel=e:this.editable?this.ariaLabel="Math Input":this.ariaLabel="",this.ariaLabel===t||this.containerHasFocus()||this.updateMathspeak(),this}getAriaLabel(){return"Math Input"!==this.ariaLabel?this.ariaLabel:this.editable?"Math Input":""}setAriaPostLabel(e,t){return e&&"string"==typeof e&&""!==e?(e!==this.ariaPostLabel&&"number"==typeof t&&(this._ariaAlertTimeout&&clearTimeout(this._ariaAlertTimeout),this._ariaAlertTimeout=setTimeout(()=>{this.containerHasFocus()?this.aria.alert(this.root.mathspeak().trim()+" "+e.trim()):this.updateMathspeak()},t)),this.ariaPostLabel=e):(this._ariaAlertTimeout&&clearTimeout(this._ariaAlertTimeout),this.ariaPostLabel=""),this}getAriaPostLabel(){return this.ariaPostLabel||""}containerHasFocus(){return document.activeElement&&this.container.contains(document.activeElement)}getTextareaOrThrow(){var e=this.textarea;if(e)return e;throw new Error("expected a textarea")}getTextareaSpanOrThrow(){var e=this.textareaSpan;if(e)return e;throw new Error("expected a textareaSpan")}addTextareaEventListeners(e){if(this.textarea)for(const r in e){var t=r;this.removeTextareaEventListener(t),this.textarea.addEventListener(t,e[t])}}removeTextareaEventListener(e){var t;this.textarea&&(t=this.textareaEventListeners[e])&&this.textarea.removeEventListener(e,t)}exportMathSpeak(){return this.root.mathspeak()}updateMathspeak(){}scrollHoriz(){}selectionChanged(){}setOverflowClasses(){}}ControllerBase.notifyees=[],API={},EMBEDS={};const processedOptions={handlers:!0,autoCommands:!0,quietEmptyDelimiters:!0,autoParenthesizedFunctions:!0,autoOperatorNames:!0,leftRightIntoCmdGoes:!0,maxDepth:!0,interpretTildeAsSim:!0},baseOptionProcessors={};class Options{constructor(e){this.version=e}assertJquery(){return pray("Interface versions > 2 do not depend on JQuery",this.version<=2),pray("JQuery is set for interface v < 3",this.jQuery),this.jQuery}}class Progenote{}insistOnInterVer=function(){window.console&&console.warn('You are using the MathQuill API without specifying an interface version, which will fail in v1.0.0. Easiest fix is to do the following before doing anything else:\n\n    MathQuill = MathQuill.getInterface(1);\n    // now MathQuill.MathField() works like it used to\n\nSee also the "`dev` branch (2014–2015) → v0.10.0 Migration Guide" at\n  https://github.com/mathquill/mathquill/wiki/%60dev%60-branch-(2014%E2%80%932015)-%E2%86%92-v0.10.0-Migration-Guide')};let MQ1;function MathQuill(e){return insistOnInterVer(),(MQ1=MQ1||getInterface(1))(e)}function getInterface(e){if(1!==e&&2!==e&&3!==e)throw"Only interface versions between "+MIN+" and "+MAX+" supported. You specified: "+e;const n=e;if(n<3){e=window.jQuery;if(!e)throw`MathQuill interface version ${n} requires jQuery 1.5.2+ to be loaded first`;Options.prototype.jQuery=e}const i=Object.assign(Object.assign({},baseOptionProcessors),{handlers:e=>({fns:e||{},APIClasses:a})});function t(e,t){var r,s;for(const a in t)if(t.hasOwnProperty(a)){if("substituteKeyboardEvents"===a&&3<=n)throw new Error(["As of interface version 3, the 'substituteKeyboardEvents'","option is no longer supported. Use 'overrideTypedText' and","'overrideKeystroke' instead."].join(" "));r=t[a],s=i[a],e[a]=s?s(r):r}}const o=n<3?Options:class extends Options{};class r extends Progenote{constructor(e){super(),this.__controller=e,this.__options=e.options,this.id=e.id,this.data=e.data}mathquillify(e){var t,r=this.__controller,s=r.root,a=r.container;r.createTextarea(),t=domFrag(a).addClass(e).children().detach(),s.setDOM(domFrag(h("span",{class:"mq-root-block","aria-hidden":!0})).appendTo(a).oneElement()),NodeBase.linkElementByBlockNode(s.domFrag().oneElement(),s),this.latex(t.text()),this.revert=function(){return r.removeMouseEventListener(),domFrag(a).removeClass("mq-editable-field mq-math-mode mq-text-mode").empty().append(t),n<3?this.__options.assertJquery()(a):a}}setAriaLabel(e){return this.__controller.setAriaLabel(e),this}getAriaLabel(){return this.__controller.getAriaLabel()}config(e){return t(this.__options,e),this}el(){return this.__controller.container}text(){return this.__controller.exportText()}mathspeak(){return this.__controller.exportMathSpeak()}latex(e){return 0<arguments.length?(this.__controller.renderLatexMath(e),e=this.__controller.cursor,this.__controller.blurred&&e.hide().parent.blur(e),this):this.__controller.exportLatex()}selection(){return this.__controller.exportLatexSelection()}html(){return this.__controller.root.domFrag().oneElement().innerHTML.replace(/ jQuery\d+="(?:\d+|null)"/g,"").replace(/ mathquill-(?:command|block)-id="?\d+"?/g,"").replace(/<span class="?mq-cursor( mq-blink)?"?>.?<\/span>/i,"").replace(/ mq-hasCursor|mq-hasCursor ?/,"").replace(/ class=(""|(?= |>))/g,"")}reflow(){return this.__controller.root.postOrder(function(e){e.reflow()}),this}cursor(){return this.__controller.cursor}controller(){return this.__controller}}class s extends r{mathquillify(e){return super.mathquillify(e),this.__controller.editable=!0,this.__controller.addMouseEventListener(),this.__controller.editablesTextareaEvents(),this}focus(){return this.__controller.getTextareaOrThrow().focus(),this.__controller.scrollHoriz(),this}blur(){return this.__controller.getTextareaOrThrow().blur(),this}write(e){this.__controller.writeLatex(e),this.__controller.scrollHoriz();e=this.__controller.cursor;return this.__controller.blurred&&e.hide().parent.blur(e),this}empty(){var e=this.__controller.root,t=this.__controller.cursor;return e.setEnds({[L]:0,[R]:0}),e.domFrag().empty(),delete t.selection,t.insAtRightEnd(e),this}cmd(e){var t,r=this.__controller.notify(void 0),s=r.cursor;return/^\\[a-z]+$/i.test(e)&&!s.isTooDeep()?(e=e.slice(1),(t=LatexCmds[e])&&(t=t.constructor?new t(e):t(e),s.selection&&t.replaces(s.replaceSelection()),t.createLeftOf(s.show()))):s.parent.write(s,e),r.scrollHoriz(),r.blurred&&s.hide().parent.blur(s),this}select(){return this.__controller.selectAll(),this}clearSelection(){return this.__controller.cursor.clearSelection(),this}moveToDirEnd(e){return this.__controller.notify("move").cursor.insAtDirEnd(e,this.__controller.root),this}moveToLeftEnd(){return this.moveToDirEnd(L)}moveToRightEnd(){return this.moveToDirEnd(R)}keystroke(e,t){for(var r=e.replace(/^\s+|\s+$/g,"").split(/\s+/),s=0;s<r.length;s+=1)this.__controller.keystroke(r[s],t);return this}typedText(e){for(var t=0;t<e.length;t+=1)this.__controller.typedText(e.charAt(t));return this}dropEmbedded(e,t,r){var e=e-getScrollX(),t=t-getScrollY(),s=document.elementFromPoint(e,t);this.__controller.seek(s,e,t),(new EmbedNode).setOptions(r).createLeftOf(this.__controller.cursor)}setAriaPostLabel(e,t){return this.__controller.setAriaPostLabel(e,t),this}getAriaPostLabel(){return this.__controller.getAriaPostLabel()}clickAt(e,t,r){r=r||document.elementFromPoint(e,t);var s=this.__controller,a=s.root.domFrag().oneElement();return a.contains(r)||(r=a),s.seek(r,e,t),s.blurred&&this.focus(),this}ignoreNextMousedown(e){return this.__controller.cursor.options.ignoreNextMousedown=e,this}}var a={AbstractMathQuill:r,EditableField:s};pray("API.StaticMath defined",API.StaticMath),a.StaticMath=API.StaticMath(a),pray("API.MathField defined",API.MathField),a.MathField=API.MathField(a),pray("API.InnerMathField defined",API.InnerMathField),a.InnerMathField=API.InnerMathField(a),API.TextField&&(a.TextField=API.TextField(a));function l(e){if(!e||!e.nodeType)return null;let t;for(const s of domFrag(e).children().toElementArray())if(s.classList.contains("mq-root-block")){t=s;break}var r=(e=(e=NodeBase.getNodeOfElement(t))&&e.controller)&&a[e.KIND_OF_MQ];return e&&r?new r(e):null}function d(s,a){function e(e,t){var r;return e&&e.nodeType?(r=l(e))instanceof a?r:((r=new Controller(new a.RootBlock,e,new o(n))).KIND_OF_MQ=s,new a(r).__mathquillify(t||{},n)):null}return pray(s+" is defined",a),e.prototype=a.prototype,e}return l.L=L,l.R=R,l.config=function(e){return t(o.prototype,e),this},l.registerEmbed=function(e,t){if(!/^[a-z][a-z0-9]*$/i.test(e))throw"Embed name must start with letter and be only letters and digits";EMBEDS[e]=t},l.StaticMath=d("StaticMath",a.StaticMath),l.MathField=d("MathField",a.MathField),l.InnerMathField=d("InnerMathField",a.InnerMathField),a.TextField&&(l.TextField=d("TextField",a.TextField)),l.prototype=r.prototype,l.EditableField=function(){throw"wtf don't call me, I'm 'abstract'"},l.EditableField.prototype=s.prototype,n<3&&(l.saneKeyboardEvents=defaultSubstituteKeyboardEvents),l}function RootBlockMixin(e){e.moveOutOf=function(e){pray("controller is defined",this.controller),this.controller.handle("moveOutOf",e)},e.deleteOutOf=function(e){pray("controller is defined",this.controller),this.controller.handle("deleteOutOf",e)},e.selectOutOf=function(e){pray("controller is defined",this.controller),this.controller.handle("selectOutOf",e)},e.upOutOf=function(){pray("controller is defined",this.controller),this.controller.handle("upOutOf")},e.downOutOf=function(){pray("controller is defined",this.controller),this.controller.handle("downOutOf")},e.reflow=function(){pray("controller is defined",this.controller),this.controller.handle("reflow"),this.controller.handle("edited"),this.controller.handle("edit")}}function parseError(e,t){throw"Parse Error: "+t+" at "+(e=e?"'"+e+"'":"EOF")}MathQuill.prototype=Progenote.prototype,MathQuill.VERSION="v0.10.1",MathQuill.interfaceVersion=function(e){if(1!==e)throw"Only interface version 1 supported. You specified: "+e;return(insistOnInterVer=function(){window.console&&console.warn('You called MathQuill.interfaceVersion(1); to specify the interface version, which will fail in v1.0.0. You can fix this easily by doing this before doing anything else:\n\n    MathQuill = MathQuill.getInterface(1);\n    // now MathQuill.MathField() works like it used to\n\nSee also the "`dev` branch (2014–2015) → v0.10.0 Migration Guide" at\n  https://github.com/mathquill/mathquill/wiki/%60dev%60-branch-(2014%E2%80%932015)-%E2%86%92-v0.10.0-Migration-Guide')})(),MathQuill},MathQuill.getInterface=getInterface,MIN=getInterface.MIN=1,MAX=getInterface.MAX=3;class Parser{constructor(e){this._=e}parse(e){return this.skip(Parser.eof)._(""+e,function(e,t){return t},parseError)}or(a){pray("or is passed a parser",a instanceof Parser);var e=this;return new Parser(function(t,r,s){return e._(t,r,function(e){return a._(t,r,s)})})}then(a){var t=this;return new Parser(function(e,r,s){return t._(e,function(e,t){t=a instanceof Parser?a:a(t);return pray("a parser is returned",t instanceof Parser),t._(e,r,s)},s)})}many(){var i=this;return new Parser(function(r,e,t){for(var s=[];i._(r,a,n););return e(r,s);function a(e,t){return r=e,s.push(t),!0}function n(){return!1}})}times(h,c){arguments.length<2&&(c=h);var m=this;return new Parser(function(r,e,t){for(var s,a=[],n=!0,i=0;i<h;i+=1)if(!(n=!!m._(r,o,l)))return t(r,s);for(;i<c&&n;i+=1)m._(r,o,d);return e(r,a);function o(e,t){return a.push(t),r=e,!0}function l(e,t){return s=t,r=e,!1}function d(e,t){return!1}})}result(e){return this.then(Parser.succeed(e))}atMost(e){return this.times(0,e)}atLeast(e){var r=this;return r.times(e).then(function(t){return r.many().map(function(e){return t.concat(e)})})}map(t){return this.then(function(e){return Parser.succeed(t(e))})}skip(t){return this.then(function(e){return t.result(e)})}static string(a){var n=a.length,i="expected '"+a+"'";return new Parser(function(e,t,r){var s=e.slice(0,n);return s===a?t(e.slice(n),s):r(e,i)})}static regex(a){pray("regexp parser is anchored","^"===a.toString().charAt(1));var n="expected "+a;return new Parser(function(e,t,r){var s=a.exec(e);return s?(s=s[0],t(e.slice(s.length),s)):r(e,n)})}static succeed(r){return new Parser(function(e,t){return t(e,r)})}static fail(s){return new Parser(function(e,t,r){return r(e,s)})}}Parser.letter=Parser.regex(/^[a-z]/i),Parser.letters=Parser.regex(/^[a-z]*/i),Parser.digit=Parser.regex(/^[0-9]/),Parser.digits=Parser.regex(/^[0-9]*/),Parser.whitespace=Parser.regex(/^\s+/),Parser.optWhitespace=Parser.regex(/^\s*/),Parser.any=new Parser(function(e,t,r){return e?t(e.slice(1),e.charAt(0)):r(e,"expected any character")}),Parser.all=new Parser(function(e,t,r){return t("",e)}),Parser.eof=new Parser(function(e,t,r){return e?r(e,"expected EOF"):t(e,e)});class EveryTick{constructor(){this.fn=noop}listen(e){this.fn=e,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(this.fn)}listenOnce(t){this.listen((...e)=>{this.clearListener(),t(...e)})}clearListener(){this.fn=noop,clearTimeout(this.timeoutId)}trigger(...e){this.fn(...e)}}saneKeyboardEvents=function(){const s={8:"Backspace",9:"Tab",10:"Enter",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Esc",32:"Spacebar",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Del",144:"NumLock"},a={ArrowRight:"Right",ArrowLeft:"Left",ArrowDown:"Down",ArrowUp:"Up",Delete:"Del",Escape:"Esc"," ":"Spacebar"};function f(e){switch(n(e)){case"Right":case"Left":case"Down":case"Up":return 1}}function n(e){var t,r;return void 0===e.key?(r=e.which||e.keyCode,s[r]||String.fromCharCode(r)):1===(r=e.key).length&&"a"<=r&&r<="z"?e.key.toUpperCase():null!=(t=a[e.key])?t:e.key}function x(e){var t=n(e),r=[];return e.ctrlKey&&r.push("Ctrl"),e.metaKey&&r.push("Meta"),e.altKey&&r.push("Alt"),e.shiftKey&&r.push("Shift"),r.length?("Alt"!==t&&"Control"!==t&&"Meta"!==t&&"Shift"!==t&&r.push(t),r.join("-")):t}return function(t,r){var s,a=null,n=null;const i=new EveryTick;function o(){try{t instanceof HTMLTextAreaElement&&t.select()}catch(e){}}function l(){r.options&&r.options.overrideKeystroke?r.options.overrideKeystroke(x(a),a):r.keystroke(x(a),a)}function e(e){i.trigger(e),e.target===t&&(a=e,n=null,s&&i.listenOnce(function(e){e&&"focusout"===e.type||o()}),l())}function d(e){i.trigger(e),e.target===t&&(a&&n&&l(),f(n=e)?i.listenOnce(m):i.listen(c))}function h(e){i.trigger(e),e.target===t&&a&&!n&&(f(e)?i.listenOnce(m):i.listen(c))}function c(){var e;"selectionStart"in t&&t instanceof HTMLTextAreaElement&&t.selectionStart!==t.selectionEnd||t instanceof HTMLTextAreaElement&&(e=t.value,a&&!a.altKey&&a.ctrlKey&&!a.metaKey&&a.shiftKey&&("U"===a.key||"Unidentified"===a.key||"Process"===a.key)||(1===e.length?(t.value="",r.options&&r.options.overrideTypedText?r.options.overrideTypedText(e):r.typedText(e)):m()))}function m(){t instanceof HTMLTextAreaElement&&1<t.value.length&&o()}function u(){n=a=null,i.clearListener(),t instanceof HTMLTextAreaElement&&(t.value="")}function p(e){i.trigger(e)}return s=!1,r.options&&r.options.disableCopyPaste?r.addTextareaEventListeners({keydown:e,keypress:d,keyup:h,focusout:u,copy:function(e){e.preventDefault()},cut:function(e){e.preventDefault()},paste:function(e){i.trigger(),e.preventDefault()},input:p}):r.addTextareaEventListeners({keydown:e,keypress:d,keyup:h,focusout:u,cut:function(){i.listenOnce(function(){r.cut()})},copy:function(){i.listenOnce(function(){r.copy()})},paste:function(e){i.trigger(),e.target===t&&(document.activeElement!==t&&t.focus(),i.listen(function(){var e;t instanceof HTMLTextAreaElement&&(e=t.value,t.value="",e)&&r.paste(e)}))},input:p}),{select:function(e){i.trigger(),i.clearListener(),t instanceof HTMLTextAreaElement&&(t.value=e),e&&o(),s=!!e}}}}();class Controller_exportText extends ControllerBase{exportText(){return this.root.foldChildren("",function(e,t){return e+t.text()})}}ControllerBase.onNotify(function(e,t){"edit"!==t&&"replace"!==t&&void 0!==t||(t=e.controller)&&t.options.enableDigitGrouping&&!1===t.blurred&&t.disableGroupingForSeconds(1)});class Controller_focusBlur extends Controller_exportText{constructor(){super(...arguments),this.handleTextareaFocusEditable=()=>{var e=this.cursor;this.updateMathspeak(),this.blurred=!1,clearTimeout(this.blurTimeout),domFrag(this.container).addClass("mq-focused"),e.parent||e.insAtRightEnd(this.root),e.selection?(e.selection.domFrag().removeClass("mq-blur"),this.selectionChanged()):e.show(),this.setOverflowClasses()},this.handleTextareaBlurEditable=()=>{this.textareaSelectionTimeout&&(clearTimeout(this.textareaSelectionTimeout),this.textareaSelectionTimeout=0),this.disableGroupingForSeconds(0),this.blurred=!0,this.blurTimeout=setTimeout(()=>{this.root.postOrder(function(e){e.intentionalBlur()}),this.cursor.clearSelection().endSelection(),this.blur(),this.updateMathspeak(),this.scrollHoriz()}),window.addEventListener("blur",this.handleWindowBlur)},this.handleTextareaFocusStatic=()=>{this.blurred=!1},this.handleTextareaBlurStatic=()=>{this.cursor.selection&&this.cursor.selection.clear(),setTimeout(()=>{domFrag(this.getTextareaSpanOrThrow()).detach(),this.blurred=!0})},this.handleWindowBlur=()=>{clearTimeout(this.blurTimeout),this.cursor.selection&&this.cursor.selection.domFrag().addClass("mq-blur"),this.blur(),this.updateMathspeak()}}disableGroupingForSeconds(e){clearTimeout(this.__disableGroupingTimeout),0===e?this.root.domFrag().removeClass("mq-suppress-grouping"):(this.root.domFrag().addClass("mq-suppress-grouping"),this.__disableGroupingTimeout=setTimeout(()=>{this.root.domFrag().removeClass("mq-suppress-grouping")},1e3*e))}blur(){this.cursor.hide().parent.blur(this.cursor),domFrag(this.container).removeClass("mq-focused"),window.removeEventListener("blur",this.handleWindowBlur),this.options&&this.options.resetCursorOnBlur&&this.cursor.resetToEnd(this)}addEditableFocusBlurListeners(){var e=this.cursor;this.addTextareaEventListeners({focus:this.handleTextareaFocusEditable,blur:this.handleTextareaBlurEditable}),this.blurred=!0,e.hide().parent.blur(e)}addStaticFocusBlurListeners(){this.addTextareaEventListeners({focus:this.handleTextareaFocusStatic,blur:this.handleTextareaBlurStatic})}}INCREMENTAL_SELECTION_OPEN=!1;class MQNode extends NodeBase{keystroke(e,t,r){var s=r.cursor;switch(e){case"Ctrl-Shift-Backspace":case"Ctrl-Backspace":r.ctrlDeleteDir(L);break;case"Shift-Backspace":case"Backspace":r.backspace();break;case"Esc":case"Tab":return void r.escapeDir(R,e,t);case"Shift-Tab":case"Shift-Esc":return void r.escapeDir(L,e,t);case"End":r.notify("move").cursor.insAtRightEnd(s.parent),r.aria.queue("end of").queue(s.parent,!0);break;case"Ctrl-End":r.notify("move").cursor.insAtRightEnd(r.root),r.aria.queue("end of").queue(r.ariaLabel).queue(r.root).queue(r.ariaPostLabel);break;case"Shift-End":r.selectToBlockEndInDir(R);break;case"Ctrl-Shift-End":r.selectToRootEndInDir(R);break;case"Home":r.notify("move").cursor.insAtLeftEnd(s.parent),r.aria.queue("beginning of").queue(s.parent,!0);break;case"Ctrl-Home":r.notify("move").cursor.insAtLeftEnd(r.root),r.aria.queue("beginning of").queue(r.ariaLabel).queue(r.root).queue(r.ariaPostLabel);break;case"Shift-Home":r.selectToBlockEndInDir(L);break;case"Ctrl-Shift-Home":r.selectToRootEndInDir(L);break;case"Left":r.moveLeft();break;case"Shift-Left":r.selectLeft();break;case"Ctrl-Left":break;case"Right":r.moveRight();break;case"Shift-Right":r.selectRight();break;case"Ctrl-Right":break;case"Up":r.moveUp();break;case"Down":r.moveDown();break;case"Shift-Up":r.withIncrementalSelection(e=>{if(s[L])for(;s[L];)e(L);else e(L)});break;case"Shift-Down":r.withIncrementalSelection(e=>{if(s[R])for(;s[R];)e(R);else e(R)});break;case"Ctrl-Up":case"Ctrl-Down":break;case"Ctrl-Shift-Del":case"Ctrl-Del":r.ctrlDeleteDir(R);break;case"Shift-Del":case"Del":r.deleteForward();break;case"Meta-A":case"Ctrl-A":r.selectAll();break;case"Ctrl-Alt-Up":s.parent.parent&&s.parent.parent instanceof MQNode?r.aria.queue(s.parent.parent):r.aria.queue("nothing above");break;case"Ctrl-Alt-Down":s.parent&&s.parent instanceof MQNode?r.aria.queue(s.parent):r.aria.queue("block is empty");break;case"Ctrl-Alt-Left":s.parent.parent&&s.parent.parent.getEnd(L)?r.aria.queue(s.parent.parent.getEnd(L)):r.aria.queue("nothing to the left");break;case"Ctrl-Alt-Right":s.parent.parent&&s.parent.parent.getEnd(R)?r.aria.queue(s.parent.parent.getEnd(R)):r.aria.queue("nothing to the right");break;case"Ctrl-Alt-Shift-Down":s.selection?r.aria.queue(s.selection.join("mathspeak"," ").trim()+" selected"):r.aria.queue("nothing selected");break;case"Ctrl-Alt-=":case"Ctrl-Alt-Shift-Right":r.ariaPostLabel.length?r.aria.queue(r.ariaPostLabel):r.aria.queue("no answer");break;default:return}r.aria.alert(),null!=t&&t.preventDefault(),r.scrollHoriz()}moveOutOf(e,t,r){pray("overridden or never called on this node",!1)}moveTowards(e,t,r){pray("overridden or never called on this node",!1)}deleteOutOf(e,t){pray("overridden or never called on this node",!1)}deleteTowards(e,t){pray("overridden or never called on this node",!1)}unselectInto(e,t){pray("overridden or never called on this node",!1)}selectOutOf(e,t){pray("overridden or never called on this node",!1)}selectTowards(e,t){pray("overridden or never called on this node",!1)}}ControllerBase.onNotify(function(e,t){"move"!==t&&"upDown"!==t||e.show().clearSelection()}),baseOptionProcessors.leftRightIntoCmdGoes=function(e){if(e&&"up"!==e&&"down"!==e)throw'"up" or "down" required for leftRightIntoCmdGoes option, got "'+e+'"';return e},ControllerBase.onNotify(function(e,t){"upDown"!==t&&(e.upDownCache={})}),ControllerBase.onNotify(function(e,t){"edit"===t&&e.show().deleteSelection()}),ControllerBase.onNotify(function(e,t){"select"!==t&&e.endSelection()});class Controller_keystroke extends Controller_focusBlur{keystroke(e,t){this.cursor.parent.keystroke(e,t,this.getControllerSelf())}escapeDir(e,t,r){prayDirection(e);var s=this.cursor;if(s.parent!==this.root&&null!=r&&r.preventDefault(),s.parent!==this.root)return s.clearSelection(),s.parent.moveOutOf(e,s),s.controller.aria.alert(),this.notify("move")}moveDir(e){var t,r,s;return prayDirection(e),r=(t=this.cursor).options.leftRightIntoCmdGoes,s=t[e],t.selection?t.insDirOf(e,t.selection.getEnd(e)):s?s.moveTowards(e,t,r):t.parent.moveOutOf(e,t,r),this.notify("move")}moveLeft(){return this.moveDir(L)}moveRight(){return this.moveDir(R)}moveUp(){return this.moveUpDown("up")}moveDown(){return this.moveUpDown("down")}moveUpDown(e){var t,r=this.notify("upDown").cursor,s="up"===e?(t="upInto","upOutOf"):(t="downInto","downOutOf"),e=r[L],a=r[R],a=a&&a[t],e=e&&e[t];return a?r.insAtLeftEnd(a):e?r.insAtRightEnd(e):r.parent.bubble(function(e){var t=e[s];if(t&&((t="function"==typeof t?t.call(e,r):t)instanceof MQNode&&r.jumpUpDown(e,t),!0!==t))return!1}),this}deleteDir(e){prayDirection(e),a=(t=this.cursor)[e],s=t.parent.parent,r=t.controller,a&&a instanceof MQNode?a.sides?r.aria.queue(a.parent.chToCmd(a.sides[-e].ch).mathspeak({createdLeftOf:t})):a.blocks||"\\text"===a.parent.ctrlSeq||r.aria.queue(a):s&&s instanceof MQNode&&(s.sides?r.aria.queue(s.parent.chToCmd(s.sides[e].ch).mathspeak({createdLeftOf:t})):s.blocks&&s.mathspeakTemplate?s.upInto&&s.downInto?r.aria.queue(s.mathspeakTemplate[1]):(a=s.mathspeakTemplate,a=e===L?a[0]:a[a.length-1],r.aria.queue(a)):r.aria.queue(s)),a=t.selection,this.notify("edit"),a||((r=t[e])?r.deleteTowards(e,t):t.parent.deleteOutOf(e,t));var t,r,s=t[L],a=t[R];return s.siblingDeleted&&s.siblingDeleted(t.options,R),a.siblingDeleted&&a.siblingDeleted(t.options,L),t.parent.bubble(function(e){e.reflow()}),this}ctrlDeleteDir(e){var t;if(prayDirection(e),!(t=this.cursor)[e]||t.selection)return this.deleteDir(e);this.notify("edit"),r=e===L?new Fragment(t.parent.getEnd(L),t[L]):new Fragment(t[R],t.parent.getEnd(R)),t.controller.aria.queue(r),r.remove(),t.insAtDirEnd(e,t.parent);var r=t[L],e=t[R];return r&&r.siblingDeleted(t.options,R),e&&e.siblingDeleted(t.options,L),t.parent.bubble(function(e){e.reflow()}),this}backspace(){return this.deleteDir(L)}deleteForward(){return this.deleteDir(R)}startIncrementalSelection(){pray("Multiple selections can't be simultaneously open",!INCREMENTAL_SELECTION_OPEN),INCREMENTAL_SELECTION_OPEN=!0,this.notify("select");var e=this.cursor;e.anticursor||e.startSelection()}selectDirIncremental(e){var t,r,s;pray("A selection is open",INCREMENTAL_SELECTION_OPEN),INCREMENTAL_SELECTION_OPEN=!0,r=(t=this.cursor).selection,prayDirection(e),(s=t[e])?r&&r.getEnd(e)===s&&t.anticursor[-e]!==s?s.unselectInto(e,t):s.selectTowards(e,t):t.parent.selectOutOf(e,t)}finishIncrementalSelection(){var e,t;pray("A selection is open",INCREMENTAL_SELECTION_OPEN),(e=this.cursor).clearSelection(),e.select()||e.show(),(t=e.selection)&&e.controller.aria.clear().queue(t.join("mathspeak"," ").trim()+" selected"),INCREMENTAL_SELECTION_OPEN=!1}withIncrementalSelection(e){try{this.startIncrementalSelection();try{e(e=>this.selectDirIncremental(e))}finally{this.finishIncrementalSelection()}}finally{INCREMENTAL_SELECTION_OPEN=!1}}selectDir(t){this.withIncrementalSelection(e=>e(t))}selectLeft(){return this.selectDir(L)}selectRight(){return this.selectDir(R)}selectAll(){this.notify("move");const t=this.cursor;t.insAtRightEnd(this.root),this.withIncrementalSelection(e=>{for(;t[L];)e(L)})}selectToBlockEndInDir(t){const r=this.cursor;this.withIncrementalSelection(e=>{for(;r[t];)e(t)})}selectToRootEndInDir(t){const r=this.cursor;this.withIncrementalSelection(e=>{for(;r[t]||r.parent!==this.root;)e(t)})}}class TempSingleCharNode extends MQNode{constructor(e){super()}}latexMathParser=function(){var e,t,r,s,a,n,i,o,l,d;function h(e){for(var t=e[0]||new MathBlock,r=1;r<e.length;r+=1)e[r].children().adopt(t,t.getEnd(R),0);return t}return e=Parser.string,a=Parser.regex,i=Parser.letter,l=Parser.digit,n=Parser.any,t=Parser.optWhitespace,r=Parser.succeed,s=Parser.fail,i=i.map(function(e){return new Letter(e)}),l=l.map(function(e){return new Digit(e)}),d=a(/^[^${}\\_^]/).map(function(e){return new VanillaSymbol(e)}),a=a(/^[^\\a-eg-zA-Z]/).or(e("\\").then(a(/^[a-z]+/i).or(a(/^\s+/).result(" ")).or(n))).then(function(e){var t=LatexCmds[e];return t?(t.constructor?new t(e):t(e)).parser():s("unknown command: \\"+e)}).or(i).or(l).or(d),n=e("{").then(function(){return o}).skip(e("}")),i=t.then(n.or(a.map(function(e){var t=new MathBlock;return e.adopt(t,0,0),t}))),o=i.many().map(h).skip(t),l=e("[").then(i.then(function(e){return"]"!==e.join("latex")?r(e):s("")}).many().map(h).skip(t)).skip(e("]")),(d=o).block=i,d.optBlock=l,d}(),baseOptionProcessors.maxDepth=function(e){return"number"==typeof e?e:void 0};class Controller_latex extends Controller_keystroke{cleanLatex(e){return e.replace(/(\\[a-z]+) (?![a-z])/gi,"$1")}exportLatex(){return this.cleanLatex(this.root.latex())}writeLatex(e){var t=this.notify("edit").cursor;return t.parent.writeLatex(t,e),this}exportLatexSelection(){var e,t,r,s,a,n,i={latex:"",startIndex:-1,endIndex:-1},o=this.cursor.selection;for(o?(i.startSelectionBefore=o.getEnd(L),i.endSelectionAfter=o.getEnd(R)):((o=this.cursor[L])?i.startSelectionAfter=o:i.startSelectionBefore=this.cursor.parent,(o=this.cursor[R])?i.endSelectionBefore=o:i.endSelectionAfter=this.cursor.parent),this.root.latexRecursive(i),t=this.cleanLatex(e=i.latex),r=i.startIndex,s=i.endIndex,n=a=0;n<i.endIndex;n++)e[n]!==t[a]?(n<i.startIndex&&--r,--s):a+=1;return{latex:t,startIndex:r,endIndex:s}}classifyLatexForEfficientUpdate(e){var t;return"string"==typeof e&&(t=e.match(/-?[0-9.]+$/g))&&1===t.length?{latex:e,prefix:e.substr(0,e.length-t[0].length),digits:t[0]}:void 0}updateLatexMathEfficiently(e,t){var r,s,a,n,i,o,l,d,h,c,m,u=this.root,p=this.classifyLatexForEfficientUpdate(e);if(!p)return!1;if(!(t=this.classifyLatexForEfficientUpdate(t))||t.prefix!==p.prefix)return!1;for(r=t.digits,s=p.digits,p=t=!1,"-"===r[0]&&(t=!0,r=r.substr(1)),"-"===s[0]&&(p=!0,s=s.substr(1)),a=this.root.getEnd(R),n=[],i=r.length-1;0<=i;i--){if(!a||a.ctrlSeq!==r[i])return!1;if(a.parent!==u)return!1;n.unshift(a),a=a[L]}if(t&&!p){if(!(m=a))return!1;if("-"!==m.ctrlSeq)return!1;if(m[R]!==n[0])return!1;if(m.parent!==u)return!1;var f=m[L];if(f&&f.parent!==u)return!1;n[0][L]=m[L],u.getEnd(L)===m&&u.setEnds({[L]:n[0],[R]:u.getEnd(R)}),f&&(f[R]=n[0]),m.domFrag().remove()}for(!t&&p&&(f=new PlusMinus("-"),(m=document.createElement("span")).textContent="-",f.setDOM(m),(t=n[0][L])&&(t[R]=f),u.getEnd(L)===n[0]&&u.setEnds({[L]:f,[R]:u.getEnd(R)}),f.parent=u,f[L]=n[0][L],f[R]=n[0],(n[0][L]=f).contactWeld(this.cursor),f.domFrag().insertBefore(n[0].domFrag())),o=Math.min(r.length,s.length),i=0;i<o;i++)l=s[i],(a=n[i]).ctrlSeq!==l&&(a.ctrlSeq=l,a.domFrag().oneElement().textContent=l,a.mathspeakName=l);if(r.length>s.length)for(a=n[s.length-1],u.setEnds({[L]:u.getEnd(L),[R]:a}),a[R]=0,i=r.length-1;o<=i;i--)n[i].domFrag().remove();if(s.length>r.length){for(d=document.createDocumentFragment(),i=o;i<s.length;i++)(h=document.createElement("span")).className="mq-digit",h.textContent=s[i],(c=new Digit(s[i])).parent=u,c.setDOM(h),d.appendChild(h),c[L]=u.getEnd(R),c[R]=0,c[L][R]=c,u.setEnds({[L]:u.getEnd(L),[R]:c});u.domFrag().oneElement().appendChild(d)}return(p=this.exportLatex())!==e?(console.warn("tried updating latex efficiently but did not work. Attempted: "+e+" but wrote: "+p),!1):((m=u.getEnd(R))&&m.fixDigitGrouping(this.cursor.options),!0)}renderLatexMathFromScratch(e){var t=this.root,r=this.cursor,s=Parser.all,a=Parser.eof,a=latexMathParser.skip(a).or(s.result(!1)).parse(e);t.setEnds({[L]:0,[R]:0}),a&&a.children().adopt(t,0,0),a?((s=t.domFrag()).children().remove(),s.oneElement().appendChild(a.html()),t.finalizeInsert(r.options,r)):t.domFrag().empty()}renderLatexMath(e){var t,r=this.cursor,s=this.root;this.notify("replace"),r.clearSelection(),t=this.exportLatex(),s.getEnd(L)&&s.getEnd(R)&&t===e||(this.updateLatexMathEfficiently(e,t)||this.renderLatexMathFromScratch(e),this.updateMathspeak()),r.insAtRightEnd(s)}renderLatexText(e){var t,r,s,a,n,i,o,l=this.root,d=this.cursor;if(l.domFrag().children().slice(1).remove(),l.setEnds({[L]:0,[R]:0}),delete d.selection,d.show().insAtRightEnd(l),t=Parser.regex,n=Parser.string,r=Parser.eof,s=Parser.all,a=n("$").then(latexMathParser).skip(n("$").or(r)).map(function(e){var t,r=new RootMathCommand(d);return r.createBlocks(),t=r.getEnd(L),e.children().adopt(t,0,0),r}),n=n("\\$").result("$").or(t(/^[^$]/)).map(e=>new VanillaSymbol(e)),i=a.or(n).many().skip(r).or(s.result(!1)).parse(e)){for(o=0;o<i.length;o+=1)i[o].adopt(l,l.getEnd(R),0);domFrag(l.html()).appendTo(l.domFrag().oneElement()),l.finalizeInsert(d.options,d)}}}const ignoreNextMouseDownNoop=e=>!1;Options.prototype.ignoreNextMousedown=ignoreNextMouseDownNoop,ControllerBase.onNotify(function(e,t){"edit"!==t&&"replace"!==t||cancelSelectionOnEdit&&cancelSelectionOnEdit.cursor===e&&cancelSelectionOnEdit.cb()});class Controller_mouse extends Controller_latex{constructor(){super(...arguments),this.handleMouseDown=e=>{var t,r,s,a,n,i,o;const l=closest(e.target,".mq-root-block"),d=(n=l&&NodeBase.getNodeOfElement(l)||NodeBase.getNodeOfElement(this.root.domFrag().oneElement())).domFrag().firstNode().ownerDocument;function h(e){i=e.target}function c(e){r.anticursor||r.startSelection(),t.seek(i,e.clientX,e.clientY).cursor.select(),r.selection&&r.controller.aria.clear().queue(r.selection.join("mathspeak")+" selected").alert(),i=null}function m(){null!==l&&void 0!==l&&l.removeEventListener("mousemove",h),null!==d&&void 0!==d&&d.removeEventListener("mousemove",c),null!==d&&void 0!==d&&d.removeEventListener("mouseup",p),cancelSelectionOnEdit=void 0}function u(){t.editable?(r.show(),r.controller.aria.queue(r.parent).alert()):domFrag(a).detach()}function p(){r.blink=s,r.selection||u(),m()}t=n.controller,r=t.cursor,s=r.blink,a=t.getTextareaSpanOrThrow(),n=t.getTextareaOrThrow(),e.preventDefault(),e.target.unselectable=!0,r.options.ignoreNextMousedown(e)||closest(e.target,".mq-ignore-mousedown")||(i=null,cancelSelectionOnEdit={cursor:r,cb:function(){o=!0,r.blink=s,r.clearSelection(),u(),m()}},t.blurred&&(l&&!t.editable&&domFrag(l).prepend(domFrag(a)),n.focus(),o))||(r.blink=noop,t.seek(e.target,e.clientX,e.clientY).cursor.startSelection(),null!==l&&void 0!==l&&l.addEventListener("mousemove",h),null!==d&&void 0!==d&&d.addEventListener("mousemove",c),null!==d&&void 0!==d&&d.addEventListener("mouseup",p))}}addMouseEventListener(){this.container.addEventListener("mousedown",this.handleMouseDown)}removeMouseEventListener(){this.container.removeEventListener("mousedown",this.handleMouseDown)}seek(e,t,r){for(var s,a=this.notify("select").cursor;e&&!(s=NodeBase.getNodeOfElement(e));)e=e.parentElement;return s=s||this.root,a.clearSelection().show(),s.seek(t,a),this.scrollHoriz(),this}}class Controller_scrollHoriz extends Controller_mouse{setOverflowClasses(){var e,t,r=this.root.domFrag().oneElement(),s=!1,a=!1;this.blurred||(t=getBoundingClientRect(r).width,e=r.scrollWidth,s=t+(t=r.scrollLeft)<e,a=0<t),r.classList.contains("mq-editing-overflow-right")!==s&&r.classList.toggle("mq-editing-overflow-right"),r.classList.contains("mq-editing-overflow-left")!==a&&r.classList.toggle("mq-editing-overflow-left")}scrollHoriz(){var s,e,t,r,a=this.cursor,n=a.selection,i=getBoundingClientRect(this.root.domFrag().oneElement());if(a.domFrag().isEmpty()&&!n){this.cancelScrollHoriz&&(this.cancelScrollHoriz(),this.cancelScrollHoriz=void 0);const o=this.root.domFrag().oneElement(),l=o.scrollLeft;void animate(this.getScrollAnimationDuration(),(e,t,r)=>{1<=e?(this.cancelScrollHoriz=void 0,o.scrollLeft=0,this.setOverflowClasses()):(this.cancelScrollHoriz=r,t(),o.scrollLeft=Math.round((1-e)*l))})}else{if(n)if(e=(r=getBoundingClientRect(n.domFrag().oneElement())).left-(i.left+20),t=r.right-(i.right-20),n.getEnd(L)===a[R])if(e<0)s=e;else{if(!(0<t))return;s=r.left-t<i.left+20?e:t}else if(0<t)s=t;else{if(!(e<0))return;s=r.right-e>i.right-20?t:e}else if((n=getBoundingClientRect(a.domFrag().oneElement()).left)>i.right-20)s=n-(i.right-20);else{if(!(n<i.left+20))return;s=n-(i.left+20)}if(r=this.root.domFrag().oneElement(),!(s<0&&0===r.scrollLeft||0<s&&r.scrollWidth<=r.scrollLeft+i.width)){this.cancelScrollHoriz&&(this.cancelScrollHoriz(),this.cancelScrollHoriz=void 0);const o=this.root.domFrag().oneElement(),l=o.scrollLeft;animate(this.getScrollAnimationDuration(),(e,t,r)=>{1<=e?(this.cancelScrollHoriz=void 0,o.scrollLeft=Math.round(l+s),this.setOverflowClasses()):(this.cancelScrollHoriz=r,t(),o.scrollLeft=Math.round(l+e*s))})}}}getScrollAnimationDuration(){var e;return null!=(e=this.options.scrollAnimationDuration)?e:100}}function defaultSubstituteKeyboardEvents(e,t){return saneKeyboardEvents(e[0],t)}Options.prototype.substituteTextarea=function(){return h("textarea",{autocapitalize:"off",autocomplete:"off",autocorrect:"off",spellcheck:!1,"x-palm-disable-ste-all":!0})},Options.prototype.substituteKeyboardEvents=defaultSubstituteKeyboardEvents;class Controller extends Controller_scrollHoriz{constructor(){super(...arguments),this.selectFn=noop}createTextarea(){this.textareaSpan=h("span",{class:"mq-textarea"});var e=this.options.substituteTextarea();if(!e.nodeType)throw"substituteTextarea() must return a DOM element, got "+e;this.textarea=domFrag(e).appendTo(this.textareaSpan).oneElement();var t=this;t.cursor.selectionChanged=function(){t.selectionChanged()}}selectionChanged(){var e=this;e.textareaSelectionTimeout||(e.textareaSelectionTimeout=setTimeout(function(){e.setTextareaSelection()}))}setTextareaSelection(){this.textareaSelectionTimeout=0;var e="";this.cursor.selection&&(e=this.cleanLatex(this.cursor.selection.join("latex")),this.options.statelessClipboard)&&(e="$"+e+"$"),this.selectFn(e)}staticMathTextareaEvents(){var r=this;this.removeTextareaEventListener("cut"),this.removeTextareaEventListener("paste"),r.options.disableCopyPaste?this.removeTextareaEventListener("copy"):this.addTextareaEventListeners({copy:function(){r.setTextareaSelection()}}),this.addStaticFocusBlurListeners(),r.selectFn=function(e){var t=r.getTextareaOrThrow();t instanceof HTMLTextAreaElement&&(t.value=e)&&t.select()}}editablesTextareaEvents(){var t,e,r=this.getTextareaOrThrow(),s=this.getTextareaSpanOrThrow();this.options.version<3?(e=this.options.assertJquery(),t=this.options.substituteKeyboardEvents(e(r),this),this.selectFn=function(e){t.select(e)}):(e=saneKeyboardEvents(r,this)["select"],this.selectFn=e),domFrag(this.container).prepend(domFrag(s)),this.addEditableFocusBlurListeners(),this.updateMathspeak()}unbindEditablesEvents(){const t=this.getTextareaOrThrow();var e=this.getTextareaSpanOrThrow();this.selectFn=function(e){t instanceof HTMLTextAreaElement&&(t.value=e)&&t.select()},domFrag(e).remove(),this.removeTextareaEventListener("focus"),this.removeTextareaEventListener("blur"),this.blurred=!0,this.removeTextareaEventListener("cut"),this.removeTextareaEventListener("paste")}typedText(e){if("\n"===e)return this.handle("enter");var t=this.notify(void 0).cursor;t.parent.write(t,e),this.scrollHoriz()}cut(){var e=this,t=e.cursor;t.selection&&setTimeout(function(){e.notify("edit"),t.parent.bubble(function(e){e.reflow()}),e.options&&e.options.onCut&&e.options.onCut()})}copy(){this.setTextareaSelection()}paste(e){this.options.statelessClipboard&&(e="$"===e.slice(0,1)&&"$"===e.slice(-1)?e.slice(1,-1):"\\text{"+e+"}"),this.writeLatex(e).cursor.show(),this.scrollHoriz(),this.options&&this.options.onPaste&&this.options.onPaste()}setupStaticField(){this.mathspeakSpan=h("span",{class:"mq-mathspeak"}),domFrag(this.container).prepend(domFrag(this.mathspeakSpan)),this.updateMathspeak(),this.blurred=!0,this.cursor.hide().parent.blur(this.cursor)}updateMathspeak(){var e=this,t=e.getAriaLabel(),t=/[A-Za-z0-9]$/.test(t)?t+":":t,r=e.root.mathspeak().trim(),s=(this.aria.clear(),e.getTextareaOrThrow());e.mathspeakSpan?(s.setAttribute("aria-label",""),e.mathspeakSpan.textContent=(t+" "+r).trim()):s.setAttribute("aria-label",(t+" "+r+" "+e.ariaPostLabel).trim())}}class MathElement extends MQNode{finalizeInsert(t,r){var e,s,a=this;a.postOrder(function(e){e.finalizeTree(t)}),a.postOrder(function(e){e.contactWeld(r)}),a.postOrder(function(e){e.blur(r)}),a.postOrder(function(e){e.reflow()}),e=a[R],s=a[L],e&&e.siblingCreated(t,L),s&&s.siblingCreated(t,R),a.bubble(function(e){e.reflow()})}prepareInsertionAt(e){var t=e.options.maxDepth;if(void 0!==t){if(t<(e=e.depth()))return!1;this.removeNodesDeeperThan(t-e)}return!0}removeNodesDeeperThan(r){for(var e,s,a=0,n=[[this,a]];e=n.shift();)(s=e)[0].children().each(function(e){var t=e instanceof MathBlock?1:0;(a=s[1]+t)<=r?n.push([e,a]):(t?e.children():e).remove()})}}class DOMView{constructor(e,t){this.childCount=e,this.render=t}}class MathCommand extends MathElement{constructor(e,t,r){super(),this.textTemplate=[""],this.mathspeakTemplate=[""],this.setCtrlSeqHtmlAndText(e,t,r)}setEnds(e){pray("MathCommand ends are never empty",e[L]&&e[R]),this.ends=e}getEnd(e){return this.ends[e]}setCtrlSeqHtmlAndText(e,t,r){this.ctrlSeq||(this.ctrlSeq=e),t&&(this.domView=t),r&&(this.textTemplate=r)}replaces(e){e.disown(),this.replacedFragment=e}isEmpty(){return this.foldChildren(!0,function(e,t){return e&&t.isEmpty()})}parser(){return latexMathParser.block.times(this.numBlocks()).map(e=>{this.blocks=e;for(var t=0;t<e.length;t+=1)e[t].adopt(this,this.getEnd(R),0);return this})}createLeftOf(e){var t,r=this,s=r.replacedFragment;r.createBlocks(),super.createLeftOf(e),s&&(t=r.getEnd(L),s.adopt(t,0,0),s.domFrag().appendTo(t.domFrag().oneElement()),r.placeCursor(e),r.prepareInsertionAt(e)),r.finalizeInsert(e.options,e),r.placeCursor(e)}createBlocks(){for(var e=this.numBlocks(),t=this.blocks=Array(e),r=0;r<e;r+=1)(t[r]=new MathBlock).adopt(this,this.getEnd(R),0)}placeCursor(e){e.insAtRightEnd(this.foldChildren(this.getEnd(L),function(e,t){return e.isEmpty()?e:t}))}moveTowards(e,t,r){"up"===r?s=this.upInto:"down"===r&&(s=this.downInto);var s,r=s||this.getEnd(-e);t.insAtDirEnd(-e,r),t.controller.aria.queueDirEndOf(-e).queue(t.parent,!0)}deleteTowards(e,t){this.isEmpty()?t[e]=this.remove()[e]:this.moveTowards(e,t)}selectTowards(e,t){t[-e]=this,t[e]=this[e]}selectChildren(){return new MQSelection(this,this)}unselectInto(e,t){var r=t.anticursor.ancestors[this.id];t.insAtDirEnd(-e,r)}seek(r,s){var a,n,i;function o(e){var e=e.domFrag().oneElement(),t=getBoundingClientRect(e).left,e=t+e.offsetWidth;return{[L]:t,[R]:e}}return n=o(a=this),r<n[L]?s.insLeftOf(a):r>n[R]?s.insRightOf(a):(i=n[L],void a.eachChild(function(e){var t=o(e);return r<t[L]?(r-i<t[L]-r?e[L]?s.insAtRightEnd(e[L]):s.insLeftOf(a):s.insAtLeftEnd(e),!1):r>t[R]?void(e[R]?i=t[R]:n[R]-r<r-t[R]?s.insRightOf(a):s.insAtRightEnd(e)):(e.seek(r,s),!1)}))}numBlocks(){return this.domView.childCount}html(){var e=this.blocks;pray("domView is defined",this.domView);e=this.domView.render(e||[]);return this.setDOM(e),NodeBase.linkElementByCmdNode(e,this),e}latexRecursive(r){this.checkCursorContextOpen(r),r.latex+=this.ctrlSeq||"",this.eachChild(e=>{r.latex+="{";var t=r.latex.length,e=(e.latexRecursive(r),r.latex.length);t===e&&(r.latex+=" "),r.latex+="}"}),this.checkCursorContextClose(r)}text(){var r=this,s=0;return r.foldChildren(r.textTemplate[s],function(e,t){s+=1;t=t.text();return e&&"("===r.textTemplate[s]&&"("===t[0]&&")"===t.slice(-1)?e+t.slice(1,-1)+r.textTemplate[s]:e+t+(r.textTemplate[s]||"")})}mathspeak(){var r=this,s=0;return r.foldChildren(r.mathspeakTemplate[s]||"Start"+r.ctrlSeq+" ",function(e,t){return s+=1,e+" "+t.mathspeak()+" "+(r.mathspeakTemplate[s]+" "||"End"+r.ctrlSeq+" ")})}}class MQSymbol extends MathCommand{constructor(e,t,r,s){super(),this.setCtrlSeqHtmlTextAndMathspeak(e,t?new DOMView(0,()=>t.cloneNode(!0)):void 0,r,s)}setCtrlSeqHtmlTextAndMathspeak(e,t,r,s){!r&&e&&(r=e.replace(/^\\/,"")),this.mathspeakName=s||r,super.setCtrlSeqHtmlAndText(e,t,[r||""])}parser(){return Parser.succeed(this)}numBlocks(){return 0}replaces(e){e.remove()}createBlocks(){}moveTowards(e,t){t.domFrag().insDirOf(e,this.domFrag()),t[-e]=this,t[e]=this[e],t.controller.aria.queue(this)}deleteTowards(e,t){t[e]=this.remove()[e]}seek(e,t){var r=this.domFrag().oneElement();return e-getBoundingClientRect(r).left<r.offsetWidth/2?t.insLeftOf(this):t.insRightOf(this),t}latexRecursive(e){this.checkCursorContextOpen(e),e.latex+=this.ctrlSeq||"",this.checkCursorContextClose(e)}text(){return this.textTemplate.join("")}mathspeak(e){return this.mathspeakName||""}placeCursor(){}isEmpty(){return!0}}class VanillaSymbol extends MQSymbol{constructor(e,t,r){super(e,h("span",{},[t||h.text(e)]),void 0,r)}}function bindVanillaSymbol(e,t,r){return()=>new VanillaSymbol(e,t?h.entityText(t):void 0,r)}class BinaryOperator extends MQSymbol{constructor(e,t,r,s,a){a?super(e,h("span",{},[t||h.text(e||"")]),void 0,s):super(e,h("span",{class:"mq-binary-operator"},t?[t]:[]),r,s)}}function bindBinaryOperator(e,t,r,s){return()=>new BinaryOperator(e,t?h.entityText(t):void 0,r,s)}class MathBlock extends MathElement{constructor(){super(...arguments),this.ariaLabel="block"}join(r){return this.foldChildren("",function(e,t){return e+t[r]()})}html(){const t=document.createDocumentFragment();return this.eachChild(e=>{e=e.html();t.appendChild(e)}),t}latexRecursive(t){this.checkCursorContextOpen(t),this.eachChild(e=>e.latexRecursive(t)),this.checkCursorContextClose(t)}text(){var e=this.getEnd(L);return e===this.getEnd(R)&&0!==e?e.text():this.join("text")}mathspeak(){var a="",n={};return this.controller&&(n=this.controller.options.autoOperatorNames),this.foldChildren([],function(e,t){var r,s;return t.isPartOfOperator?a+=t.mathspeak():(""!==a&&(0<n._maxLength&&"string"==typeof(r=n[a.toLowerCase()])&&(a=r),e.push(a+" "),a=""),r=t.mathspeak(),s=t.ctrlSeq,!isNaN(s)||"."===s||t.parent&&t.parent.parent&&t.parent.parent.isTextBlock()||(r=" "+r+" "),e.push(r)),e}).join("").replace(/ +(?= )/g,"").replace(/(\.)([0-9]+)/g,function(e,t,r){return t+r.split("").join(" ").trim()})}keystroke(e,t,r){if(!r.options.spaceBehavesLikeTab||"Spacebar"!==e&&"Shift-Spacebar"!==e)return super.keystroke(e,t,r);null!=t&&t.preventDefault(),r.escapeDir("Shift-Spacebar"===e?L:R,e,t)}moveOutOf(e,t,r){var s;"up"===r?s=this.parent.upInto:"down"===r&&(s=this.parent.downInto),!s&&this[e]?(t.insAtDirEnd(r=-e,this[e]),t.controller.aria.queueDirEndOf(r).queue(t.parent,!0)):(t.insDirOf(e,this.parent),t.controller.aria.queueDirOf(e).queue(this.parent))}selectOutOf(e,t){t.insDirOf(e,this.parent)}deleteOutOf(e,t){t.unwrapGramp()}seek(e,t){var r=this.getEnd(R);if(!r)return t.insAtRightEnd(this);var s=r.domFrag().oneElement();if(getBoundingClientRect(s).left+s.offsetWidth<e)return t.insAtRightEnd(this);if(e<getBoundingClientRect(this.getEnd(L).domFrag().oneElement()).left)return t.insAtLeftEnd(this);for(;e<getBoundingClientRect(r.domFrag().oneElement()).left;)r=r[L];return r.seek(e,t)}chToCmd(e,t){return e.match(/^[a-eg-zA-Z]$/)?new Letter(e):/^\d$/.test(e)?new Digit(e):t&&t.typingSlashWritesDivisionSymbol&&"/"===e?LatexCmds["÷"](e):t&&t.typingAsteriskWritesTimesSymbol&&"*"===e?LatexCmds["×"](e):t&&t.typingPercentWritesPercentOf&&"%"===e?LatexCmds.percentof(e):(t=CharCmds[e]||LatexCmds[e])?t.constructor?new t(e):t(e):new VanillaSymbol(e)}write(e,t){var r=this.chToCmd(t,e.options);e.selection&&r.replaces(e.replaceSelection()),e.isTooDeep()||(r.createLeftOf(e.show()),"/"===t?e.controller.aria.alert("over"):e.controller.aria.alert(r.mathspeak({createdLeftOf:e})))}writeLatex(e,t){var r=Parser.all,s=Parser.eof,s=latexMathParser.skip(s).or(r.result(!1)).parse(t);s&&!s.isEmpty()&&s.prepareInsertionAt(e)&&(s.children().adopt(e.parent,e[L],e[R]),domFrag(s.html()).insertBefore(e.domFrag()),e[L]=s.getEnd(R),s.finalizeInsert(e.options,e),r=s.getEnd(R),t=s.getEnd(L),s=r[R],r=t[L],s&&s.siblingCreated(e.options,L),r&&r.siblingCreated(e.options,R),e.parent.bubble(function(e){e.reflow()}))}focus(){return this.domFrag().addClass("mq-hasCursor"),this.domFrag().removeClass("mq-empty"),this}blur(e){return this.domFrag().removeClass("mq-hasCursor"),this.isEmpty()&&(this.domFrag().addClass("mq-empty"),e)&&this.isQuietEmptyDelimiter(e.options.quietEmptyDelimiters)&&this.domFrag().addClass("mq-quiet-delimiter"),this}}Options.prototype.mouseEvents=!0,API.StaticMath=function(s){var e=class extends s.AbstractMathQuill{constructor(e){super(e);var t=this.innerFields=[];this.__controller.root.postOrder(function(e){e.registerInnerField(t,s.InnerMathField)})}__mathquillify(e,t){return this.config(e),super.mathquillify("mq-math-mode"),this.__controller.setupStaticField(),this.__options.mouseEvents&&(this.__controller.addMouseEventListener(),this.__controller.staticMathTextareaEvents()),this}latex(e){var t,r=super.latex.apply(this,arguments);return 0<arguments.length&&(t=this.innerFields=[],this.__controller.root.postOrder(function(e){e.registerInnerField(t,s.InnerMathField)}),this.__controller.updateMathspeak()),r}setAriaLabel(e){return this.__controller.setAriaLabel(e),this}getAriaLabel(){return this.__controller.getAriaLabel()}};return e.RootBlock=MathBlock,e};class RootMathBlock extends MathBlock{}RootBlockMixin(RootMathBlock.prototype),API.MathField=function(e){e=class extends e.EditableField{__mathquillify(e,t){return this.config(e),1<t&&(this.__controller.root.reflow=noop),super.mathquillify("mq-editable-field mq-math-mode"),delete this.__controller.root.reflow,this}};return e.RootBlock=RootMathBlock,e},API.InnerMathField=function(e){return pray("MathField class is defined",e.MathField),class extends e.MathField{makeStatic(){this.__controller.editable=!1,this.__controller.root.blur(),this.__controller.unbindEditablesEvents(),domFrag(this.__controller.container).removeClass("mq-editable-field")}makeEditable(){this.__controller.editable=!0,this.__controller.editablesTextareaEvents(),this.__controller.cursor.insAtRightEnd(this.__controller.root),domFrag(this.__controller.container).addClass("mq-editable-field")}}},LatexCmds.notin=LatexCmds.cong=LatexCmds.equiv=LatexCmds.oplus=LatexCmds.otimes=e=>new BinaryOperator("\\"+e+" ",h.entityText("&"+e+";")),LatexCmds["∗"]=LatexCmds.ast=LatexCmds.star=LatexCmds.loast=LatexCmds.lowast=bindBinaryOperator("\\ast ","&lowast;","low asterisk"),LatexCmds.therefor=LatexCmds.therefore=bindBinaryOperator("\\therefore ","&there4;","therefore"),LatexCmds.cuz=LatexCmds.because=bindBinaryOperator("\\because ","&#8757;","because"),LatexCmds.prop=LatexCmds.propto=bindBinaryOperator("\\propto ","&prop;","proportional to"),LatexCmds["≈"]=LatexCmds.asymp=LatexCmds.approx=bindBinaryOperator("\\approx ","&asymp;","approximately equal to"),LatexCmds.isin=LatexCmds.in=bindBinaryOperator("\\in ","&isin;","is in"),LatexCmds.ni=LatexCmds.contains=bindBinaryOperator("\\ni ","&ni;","is not in"),LatexCmds.notni=LatexCmds.niton=LatexCmds.notcontains=LatexCmds.doesnotcontain=bindBinaryOperator("\\not\\ni ","&#8716;","does not contain"),LatexCmds.sub=LatexCmds.subset=bindBinaryOperator("\\subset ","&sub;","subset"),LatexCmds.sup=LatexCmds.supset=LatexCmds.superset=bindBinaryOperator("\\supset ","&sup;","superset"),LatexCmds.nsub=LatexCmds.notsub=LatexCmds.nsubset=LatexCmds.notsubset=bindBinaryOperator("\\not\\subset ","&#8836;","not a subset"),LatexCmds.nsup=LatexCmds.notsup=LatexCmds.nsupset=LatexCmds.notsupset=LatexCmds.nsuperset=LatexCmds.notsuperset=bindBinaryOperator("\\not\\supset ","&#8837;","not a superset"),LatexCmds.sube=LatexCmds.subeq=LatexCmds.subsete=LatexCmds.subseteq=bindBinaryOperator("\\subseteq ","&sube;","subset or equal to"),LatexCmds.supe=LatexCmds.supeq=LatexCmds.supsete=LatexCmds.supseteq=LatexCmds.supersete=LatexCmds.superseteq=bindBinaryOperator("\\supseteq ","&supe;","superset or equal to"),LatexCmds.nsube=LatexCmds.nsubeq=LatexCmds.notsube=LatexCmds.notsubeq=LatexCmds.nsubsete=LatexCmds.nsubseteq=LatexCmds.notsubsete=LatexCmds.notsubseteq=bindBinaryOperator("\\not\\subseteq ","&#8840;","not subset or equal to"),LatexCmds.nsupe=LatexCmds.nsupeq=LatexCmds.notsupe=LatexCmds.notsupeq=LatexCmds.nsupsete=LatexCmds.nsupseteq=LatexCmds.notsupsete=LatexCmds.notsupseteq=LatexCmds.nsupersete=LatexCmds.nsuperseteq=LatexCmds.notsupersete=LatexCmds.notsuperseteq=bindBinaryOperator("\\not\\supseteq ","&#8841;","not superset or equal to"),LatexCmds.mathbb=class extends MathCommand{createLeftOf(e){}numBlocks(){return 1}parser(){var e=Parser.string,t=Parser.regex,r=Parser.optWhitespace;return r.then(e("{")).then(r).then(t(/^[NPZQRCH]/)).skip(r).skip(e("}")).map(function(e){e=LatexCmds[e];return isMQNodeClass(e)?new e:e()})}},LatexCmds.N=LatexCmds.naturals=LatexCmds.Naturals=bindVanillaSymbol("\\mathbb{N}","&#8469;","naturals"),LatexCmds.P=LatexCmds.primes=LatexCmds.Primes=LatexCmds.projective=LatexCmds.Projective=LatexCmds.probability=LatexCmds.Probability=bindVanillaSymbol("\\mathbb{P}","&#8473;","P"),LatexCmds.Z=LatexCmds.integers=LatexCmds.Integers=bindVanillaSymbol("\\mathbb{Z}","&#8484;","integers"),LatexCmds.Q=LatexCmds.rationals=LatexCmds.Rationals=bindVanillaSymbol("\\mathbb{Q}","&#8474;","rationals"),LatexCmds.R=LatexCmds.reals=LatexCmds.Reals=bindVanillaSymbol("\\mathbb{R}","&#8477;","reals"),LatexCmds.C=LatexCmds.complex=LatexCmds.Complex=LatexCmds.complexes=LatexCmds.Complexes=LatexCmds.complexplane=LatexCmds.Complexplane=LatexCmds.ComplexPlane=bindVanillaSymbol("\\mathbb{C}","&#8450;","complexes"),LatexCmds.H=LatexCmds.Hamiltonian=LatexCmds.quaternions=LatexCmds.Quaternions=bindVanillaSymbol("\\mathbb{H}","&#8461;","quaternions"),LatexCmds.quad=LatexCmds.emsp=bindVanillaSymbol("\\quad ","    ","4 spaces"),LatexCmds.qquad=bindVanillaSymbol("\\qquad ","        ","8 spaces"),LatexCmds.diamond=bindVanillaSymbol("\\diamond ","&#9671;","diamond"),LatexCmds.bigtriangleup=bindVanillaSymbol("\\bigtriangleup ","&#9651;","triangle up"),LatexCmds.ominus=bindVanillaSymbol("\\ominus ","&#8854;","o minus"),LatexCmds.uplus=bindVanillaSymbol("\\uplus ","&#8846;","disjoint union"),LatexCmds.bigtriangledown=bindVanillaSymbol("\\bigtriangledown ","&#9661;","triangle down"),LatexCmds.sqcap=bindVanillaSymbol("\\sqcap ","&#8851;","greatest lower bound"),LatexCmds.triangleleft=bindVanillaSymbol("\\triangleleft ","&#8882;","triangle left"),LatexCmds.sqcup=bindVanillaSymbol("\\sqcup ","&#8852;","least upper bound"),LatexCmds.triangleright=bindVanillaSymbol("\\triangleright ","&#8883;","triangle right"),LatexCmds.odot=LatexCmds.circledot=bindVanillaSymbol("\\odot ","&#8857;","circle dot"),LatexCmds.bigcirc=bindVanillaSymbol("\\bigcirc ","&#9711;","circle"),LatexCmds.dagger=bindVanillaSymbol("\\dagger ","&#0134;","dagger"),LatexCmds.ddagger=bindVanillaSymbol("\\ddagger ","&#135;","big dagger"),LatexCmds.wr=bindVanillaSymbol("\\wr ","&#8768;","wreath"),LatexCmds.amalg=bindVanillaSymbol("\\amalg ","&#8720;","amalgam"),LatexCmds.models=bindVanillaSymbol("\\models ","&#8872;","models"),LatexCmds.prec=bindVanillaSymbol("\\prec ","&#8826;","precedes"),LatexCmds.succ=bindVanillaSymbol("\\succ ","&#8827;","succeeds"),LatexCmds.preceq=bindVanillaSymbol("\\preceq ","&#8828;","precedes or equals"),LatexCmds.succeq=bindVanillaSymbol("\\succeq ","&#8829;","succeeds or equals"),LatexCmds.simeq=bindVanillaSymbol("\\simeq ","&#8771;","similar or equal to"),LatexCmds.mid=bindVanillaSymbol("\\mid ","&#8739;","divides"),LatexCmds.ll=bindVanillaSymbol("\\ll ","&#8810;","ll"),LatexCmds.gg=bindVanillaSymbol("\\gg ","&#8811;","gg"),LatexCmds.parallel=bindVanillaSymbol("\\parallel ","&#8741;","parallel with"),LatexCmds.nparallel=bindVanillaSymbol("\\nparallel ","&#8742;","not parallel with"),LatexCmds.bowtie=bindVanillaSymbol("\\bowtie ","&#8904;","bowtie"),LatexCmds.sqsubset=bindVanillaSymbol("\\sqsubset ","&#8847;","square subset"),LatexCmds.sqsupset=bindVanillaSymbol("\\sqsupset ","&#8848;","square superset"),LatexCmds.smile=bindVanillaSymbol("\\smile ","&#8995;","smile"),LatexCmds.sqsubseteq=bindVanillaSymbol("\\sqsubseteq ","&#8849;","square subset or equal to"),LatexCmds.sqsupseteq=bindVanillaSymbol("\\sqsupseteq ","&#8850;","square superset or equal to"),LatexCmds.doteq=bindVanillaSymbol("\\doteq ","&#8784;","dotted equals"),LatexCmds.frown=bindVanillaSymbol("\\frown ","&#8994;","frown"),LatexCmds.vdash=bindVanillaSymbol("\\vdash ","&#8870;","v dash"),LatexCmds.dashv=bindVanillaSymbol("\\dashv ","&#8867;","dash v"),LatexCmds.nless=bindVanillaSymbol("\\nless ","&#8814;","not less than"),LatexCmds.ngtr=bindVanillaSymbol("\\ngtr ","&#8815;","not greater than"),LatexCmds.longleftarrow=bindVanillaSymbol("\\longleftarrow ","&#8592;","left arrow"),LatexCmds.longrightarrow=bindVanillaSymbol("\\longrightarrow ","&#8594;","right arrow"),LatexCmds.Longleftarrow=bindVanillaSymbol("\\Longleftarrow ","&#8656;","left arrow"),LatexCmds.Longrightarrow=bindVanillaSymbol("\\Longrightarrow ","&#8658;","right arrow"),LatexCmds.longleftrightarrow=bindVanillaSymbol("\\longleftrightarrow ","&#8596;","left and right arrow"),LatexCmds.updownarrow=bindVanillaSymbol("\\updownarrow ","&#8597;","up and down arrow"),LatexCmds.Longleftrightarrow=bindVanillaSymbol("\\Longleftrightarrow ","&#8660;","left and right arrow"),LatexCmds.Updownarrow=bindVanillaSymbol("\\Updownarrow ","&#8661;","up and down arrow"),LatexCmds.mapsto=bindVanillaSymbol("\\mapsto ","&#8614;","maps to"),LatexCmds.nearrow=bindVanillaSymbol("\\nearrow ","&#8599;","northeast arrow"),LatexCmds.hookleftarrow=bindVanillaSymbol("\\hookleftarrow ","&#8617;","hook left arrow"),LatexCmds.hookrightarrow=bindVanillaSymbol("\\hookrightarrow ","&#8618;","hook right arrow"),LatexCmds.searrow=bindVanillaSymbol("\\searrow ","&#8600;","southeast arrow"),LatexCmds.leftharpoonup=bindVanillaSymbol("\\leftharpoonup ","&#8636;","left harpoon up"),LatexCmds.rightharpoonup=bindVanillaSymbol("\\rightharpoonup ","&#8640;","right harpoon up"),LatexCmds.swarrow=bindVanillaSymbol("\\swarrow ","&#8601;","southwest arrow"),LatexCmds.leftharpoondown=bindVanillaSymbol("\\leftharpoondown ","&#8637;","left harpoon down"),LatexCmds.rightharpoondown=bindVanillaSymbol("\\rightharpoondown ","&#8641;","right harpoon down"),LatexCmds.nwarrow=bindVanillaSymbol("\\nwarrow ","&#8598;","northwest arrow"),LatexCmds.ldots=bindVanillaSymbol("\\ldots ","&#8230;","l dots"),LatexCmds.cdots=bindVanillaSymbol("\\cdots ","&#8943;","c dots"),LatexCmds.vdots=bindVanillaSymbol("\\vdots ","&#8942;","v dots"),LatexCmds.ddots=bindVanillaSymbol("\\ddots ","&#8945;","d dots"),LatexCmds.surd=bindVanillaSymbol("\\surd ","&#8730;","unresolved root"),LatexCmds.triangle=bindVanillaSymbol("\\triangle ","&#9651;","triangle"),LatexCmds.ell=bindVanillaSymbol("\\ell ","&#8467;","ell"),LatexCmds.top=bindVanillaSymbol("\\top ","&#8868;","top"),LatexCmds.flat=bindVanillaSymbol("\\flat ","&#9837;","flat"),LatexCmds.natural=bindVanillaSymbol("\\natural ","&#9838;","natural"),LatexCmds.sharp=bindVanillaSymbol("\\sharp ","&#9839;","sharp"),LatexCmds.wp=bindVanillaSymbol("\\wp ","&#8472;","wp"),LatexCmds.bot=bindVanillaSymbol("\\bot ","&#8869;","bot"),LatexCmds.clubsuit=bindVanillaSymbol("\\clubsuit ","&#9827;","club suit"),LatexCmds.diamondsuit=bindVanillaSymbol("\\diamondsuit ","&#9826;","diamond suit"),LatexCmds.heartsuit=bindVanillaSymbol("\\heartsuit ","&#9825;","heart suit"),LatexCmds.spadesuit=bindVanillaSymbol("\\spadesuit ","&#9824;","spade suit"),LatexCmds.parallelogram=bindVanillaSymbol("\\parallelogram ","&#9649;","parallelogram"),LatexCmds.square=bindVanillaSymbol("\\square ","&#11036;","square"),LatexCmds.oint=bindVanillaSymbol("\\oint ","&#8750;","o int"),LatexCmds.bigcap=bindVanillaSymbol("\\bigcap ","&#8745;","big cap"),LatexCmds.bigcup=bindVanillaSymbol("\\bigcup ","&#8746;","big cup"),LatexCmds.bigsqcup=bindVanillaSymbol("\\bigsqcup ","&#8852;","big square cup"),LatexCmds.bigvee=bindVanillaSymbol("\\bigvee ","&#8744;","big vee"),LatexCmds.bigwedge=bindVanillaSymbol("\\bigwedge ","&#8743;","big wedge"),LatexCmds.bigodot=bindVanillaSymbol("\\bigodot ","&#8857;","big o dot"),LatexCmds.bigotimes=bindVanillaSymbol("\\bigotimes ","&#8855;","big o times"),LatexCmds.bigoplus=bindVanillaSymbol("\\bigoplus ","&#8853;","big o plus"),LatexCmds.biguplus=bindVanillaSymbol("\\biguplus ","&#8846;","big u plus"),LatexCmds.lfloor=bindVanillaSymbol("\\lfloor ","&#8970;","left floor"),LatexCmds.rfloor=bindVanillaSymbol("\\rfloor ","&#8971;","right floor"),LatexCmds.lceil=bindVanillaSymbol("\\lceil ","&#8968;","left ceiling"),LatexCmds.rceil=bindVanillaSymbol("\\rceil ","&#8969;","right ceiling"),LatexCmds.opencurlybrace=LatexCmds.lbrace=bindVanillaSymbol("\\lbrace ","{","left brace"),LatexCmds.closecurlybrace=LatexCmds.rbrace=bindVanillaSymbol("\\rbrace ","}","right brace"),LatexCmds.lbrack=bindVanillaSymbol("[","left bracket"),LatexCmds.rbrack=bindVanillaSymbol("]","right bracket"),LatexCmds.slash=bindVanillaSymbol("/","slash"),LatexCmds.vert=bindVanillaSymbol("|","vertical bar"),LatexCmds.perp=LatexCmds.perpendicular=bindVanillaSymbol("\\perp ","&perp;","perpendicular"),LatexCmds.nabla=LatexCmds.del=bindVanillaSymbol("\\nabla ","&nabla;"),LatexCmds.hbar=bindVanillaSymbol("\\hbar ","&#8463;","horizontal bar"),LatexCmds.AA=LatexCmds.Angstrom=LatexCmds.angstrom=bindVanillaSymbol("\\text\\AA ","&#8491;","AA"),LatexCmds.ring=LatexCmds.circ=LatexCmds.circle=bindVanillaSymbol("\\circ ","&#8728;","circle"),LatexCmds.bull=LatexCmds.bullet=bindVanillaSymbol("\\bullet ","&bull;","bullet"),LatexCmds.setminus=LatexCmds.smallsetminus=bindVanillaSymbol("\\setminus ","&#8726;","set minus"),LatexCmds.not=LatexCmds["¬"]=LatexCmds.neg=bindVanillaSymbol("\\neg ","&not;","not"),LatexCmds["…"]=LatexCmds.dots=LatexCmds.ellip=LatexCmds.hellip=LatexCmds.ellipsis=LatexCmds.hellipsis=bindVanillaSymbol("\\dots ","&hellip;","ellipsis"),LatexCmds.converges=LatexCmds.darr=LatexCmds.dnarr=LatexCmds.dnarrow=LatexCmds.downarrow=bindVanillaSymbol("\\downarrow ","&darr;","converges with"),LatexCmds.dArr=LatexCmds.dnArr=LatexCmds.dnArrow=LatexCmds.Downarrow=bindVanillaSymbol("\\Downarrow ","&dArr;","down arrow"),LatexCmds.diverges=LatexCmds.uarr=LatexCmds.uparrow=bindVanillaSymbol("\\uparrow ","&uarr;","diverges from"),LatexCmds.uArr=LatexCmds.Uparrow=bindVanillaSymbol("\\Uparrow ","&uArr;","up arrow"),LatexCmds.rarr=LatexCmds.rightarrow=bindVanillaSymbol("\\rightarrow ","&rarr;","right arrow"),LatexCmds.implies=bindBinaryOperator("\\Rightarrow ","&rArr;","implies"),LatexCmds.rArr=LatexCmds.Rightarrow=bindVanillaSymbol("\\Rightarrow ","&rArr;","right arrow"),LatexCmds.gets=bindBinaryOperator("\\gets ","&larr;","gets"),LatexCmds.larr=LatexCmds.leftarrow=bindVanillaSymbol("\\leftarrow ","&larr;","left arrow"),LatexCmds.impliedby=bindBinaryOperator("\\Leftarrow ","&lArr;","implied by"),LatexCmds.lArr=LatexCmds.Leftarrow=bindVanillaSymbol("\\Leftarrow ","&lArr;","left arrow"),LatexCmds.harr=LatexCmds.lrarr=LatexCmds.leftrightarrow=bindVanillaSymbol("\\leftrightarrow ","&harr;","left and right arrow"),LatexCmds.iff=bindBinaryOperator("\\Leftrightarrow ","&hArr;","if and only if"),LatexCmds.hArr=LatexCmds.lrArr=LatexCmds.Leftrightarrow=bindVanillaSymbol("\\Leftrightarrow ","&hArr;","left and right arrow"),LatexCmds.Re=LatexCmds.Real=LatexCmds.real=bindVanillaSymbol("\\Re ","&real;","real"),LatexCmds.Im=LatexCmds.imag=LatexCmds.image=LatexCmds.imagin=LatexCmds.imaginary=LatexCmds.Imaginary=bindVanillaSymbol("\\Im ","&image;","imaginary"),LatexCmds.part=LatexCmds.partial=bindVanillaSymbol("\\partial ","&part;","partial"),LatexCmds.pounds=bindVanillaSymbol("\\pounds ","&pound;"),LatexCmds.alef=LatexCmds.alefsym=LatexCmds.aleph=LatexCmds.alephsym=bindVanillaSymbol("\\aleph ","&alefsym;","alef sym"),LatexCmds.xist=LatexCmds.xists=LatexCmds.exist=LatexCmds.exists=bindVanillaSymbol("\\exists ","&exist;","there exists at least 1"),LatexCmds.nexists=LatexCmds.nexist=bindVanillaSymbol("\\nexists ","&#8708;","there is no"),LatexCmds.and=LatexCmds.land=LatexCmds.wedge=bindBinaryOperator("\\wedge ","&and;","and"),LatexCmds.or=LatexCmds.lor=LatexCmds.vee=bindBinaryOperator("\\vee ","&or;","or"),LatexCmds.o=LatexCmds.O=LatexCmds.empty=LatexCmds.emptyset=LatexCmds.oslash=LatexCmds.Oslash=LatexCmds.nothing=LatexCmds.varnothing=bindBinaryOperator("\\varnothing ","&empty;","nothing"),LatexCmds.cup=LatexCmds.union=bindBinaryOperator("\\cup ","&cup;","union"),LatexCmds.cap=LatexCmds.intersect=LatexCmds.intersection=bindBinaryOperator("\\cap ","&cap;","intersection"),LatexCmds.deg=LatexCmds.degree=bindVanillaSymbol("\\degree ","&deg;","degrees"),LatexCmds.ang=LatexCmds.angle=bindVanillaSymbol("\\angle ","&ang;","angle"),LatexCmds.measuredangle=bindVanillaSymbol("\\measuredangle ","&#8737;","measured angle");class DigitGroupingChar extends MQSymbol{finalizeTree(e,t){this.sharedSiblingMethod(e,t)}siblingDeleted(e,t){this.sharedSiblingMethod(e,t)}siblingCreated(e,t){this.sharedSiblingMethod(e,t)}sharedSiblingMethod(e,t){t!==L&&this[R]instanceof DigitGroupingChar||this.fixDigitGrouping(e)}fixDigitGrouping(e){var t,r,s,a,n,i;if(e.enableDigitGrouping){r=t=this,s=0,a=[],n="\\ ",i=t;do{if(/^[0-9]$/.test(i.ctrlSeq))t=i;else if(i.ctrlSeq===n)t=i,s+=1;else{if("."!==i.ctrlSeq)break;t=i,a.push(i)}}while(i=t[L]);for(;i=r[R];)if(/^[0-9]$/.test(i.ctrlSeq))r=i;else if(i.ctrlSeq===n)r=i,s+=1;else{if("."!==i.ctrlSeq)break;r=i,a.push(i)}for(;r!==t&&t&&t.ctrlSeq===n;)t=t[R],--s;for(;r!==t&&r&&r.ctrlSeq===n;)r=r[L],--s;t===r&&t&&t.ctrlSeq===n||(0<s||1<a.length?this.removeGroupingBetween(t,r):a[0]?(a[0]!==t&&this.addGroupingBetween(a[0][L],t),a[0]!==r&&this.removeGroupingBetween(a[0][R],r)):this.addGroupingBetween(r,t))}}removeGroupingBetween(e,t){var r=e;do{if(r instanceof DigitGroupingChar&&r.setGroupingClass(void 0),!r||r===t)break}while(r=r[R])}addGroupingBetween(e,t){var r,s,a=e,n=0,i=0;for(a=e;a&&(i+=1,a!==t);)a=a[L];for(0===(r=i%3)&&(r=3),a=e;a&&(n+=1,s=void 0,4<=i&&(n===i?s="mq-group-leading-"+r:n%3==0&&n!==i&&(s="mq-group-start"),s=s||"mq-group-other"),a instanceof DigitGroupingChar&&a.setGroupingClass(s),a!==t);)a=a[L]}setGroupingClass(e){this._groupingClass!==e&&(this._groupingClass&&this.domFrag().removeClass(this._groupingClass),e&&this.domFrag().addClass(e),this._groupingClass=e)}}class Digit extends DigitGroupingChar{constructor(e,t){super(e,h("span",{class:"mq-digit"},[h.text(e)]),void 0,t)}createLeftOf(e){var t=e[L],r=t&&t[L],s=e.parent.parent instanceof SupSub?e.parent.parent.sub:void 0;e.options.autoSubscriptNumerals&&e.parent!==s&&(t instanceof Variable&&!1!==t.isItalic||t instanceof SupSub&&r instanceof Variable&&!1!==r.isItalic)?((new SubscriptCommand).createLeftOf(e),super.createLeftOf(e),e.insRightOf(e.parent.parent)):super.createLeftOf(e)}mathspeak(e){if(e&&e.createdLeftOf){var t,r=(t=(e=e.createdLeftOf)[L])&&t[L],s=e.parent.parent instanceof SupSub?e.parent.parent.sub:void 0;if(e.options.autoSubscriptNumerals&&e.parent!==s&&(t instanceof Variable&&!1!==t.isItalic||e[L]instanceof SupSub&&r instanceof Variable&&!1!==r.isItalic))return"Subscript "+super.mathspeak()+" Baseline"}return super.mathspeak()}}class Variable extends MQSymbol{constructor(e,t){super(e,h("var",{},[t||h.text(e)]))}text(){var e=this.ctrlSeq||"";return this.isPartOfOperator?"\\"==e[0]?e=e.slice(1,e.length):" "==e[e.length-1]&&(e=e.slice(0,-1)):(!this[L]||this[L]instanceof Variable||this[L]instanceof BinaryOperator||"\\ "===this[L].ctrlSeq||(e="*"+e),!this[R]||this[R]instanceof BinaryOperator||this[R]instanceof SupSub||(e+="*")),e}mathspeak(){var e=this.ctrlSeq||"";return this.isPartOfOperator||1<e.length||this.parent&&this.parent.parent&&this.parent.parent.isTextBlock()?super.mathspeak():'"'+e+'"'}}function bindVariable(e,t,r){return()=>new Variable(e,h.entityText(t))}Options.prototype.autoCommands={_maxLength:0},baseOptionProcessors.autoCommands=function(e){var t,r,s,a,n;if("string"!=typeof e||!/^[a-z]+(?: [a-z]+)*$/i.test(e))throw'"'+e+'" not a space-delimited list of only letters';for(t=e.split(" "),r={},a=s=0;a<t.length;a+=1){if((n=t[a]).length<2)throw'autocommand "'+n+'" not minimum length of 2';if(LatexCmds[n]===OperatorName)throw'"'+n+'" is a built-in operator name';r[n]=1,s=max(s,n.length)}return r._maxLength=s,r},Options.prototype.quietEmptyDelimiters={},baseOptionProcessors.quietEmptyDelimiters=function(e=""){for(var t=e.split(" "),r={},s=0;s<t.length;s+=1)r[t[s]]=1;return r},Options.prototype.autoParenthesizedFunctions={_maxLength:0},baseOptionProcessors.autoParenthesizedFunctions=function(e){var t,r,s,a,n;if("string"!=typeof e||!/^[a-z]+(?: [a-z]+)*$/i.test(e))throw'"'+e+'" not a space-delimited list of only letters';for(t=e.split(" "),r={},a=s=0;a<t.length;a+=1){if((n=t[a]).length<2)throw'autocommand "'+n+'" not minimum length of 2';r[n]=1,s=max(s,n.length)}return r._maxLength=s,r};class Letter extends Variable{constructor(e){super(e),this.letter=e}checkAutoCmds(e){var t,r,s,a,n,i;if(!this.shouldIgnoreSubstitutionInSimpleSubscript(e.options)&&0<(r=(t=e.options.autoCommands)._maxLength||0)){for(s="",a=this,n=0;a instanceof Letter&&a.ctrlSeq===a.letter&&n<r;)s=a.letter+s,a=a[L],n+=1;for(;s.length;){if(t.hasOwnProperty(s)){for(a=this,n=1;a&&n<s.length;n+=1,a=a[L]);return new Fragment(a,this).remove(),e[L]=a[L],(isMQNodeClass(i=LatexCmds[s])?new i(s):i(s)).createLeftOf(e)}s=s.slice(1)}}}autoParenthesize(e){var t,r,s,a,n,i,o=e.parent.getEnd(R);if(!(o&&o instanceof Bracket&&"\\left("===o.ctrlSeq||this.shouldIgnoreSubstitutionInSimpleSubscript(e.options))){for(t="",r=this,s=0,n=(a=e.options.autoParenthesizedFunctions)._maxLength||0,i=e.options.autoOperatorNames;r instanceof Letter&&s<n;)t=r.letter+t,r=r[L],s+=1;for(;t.length;){if(a.hasOwnProperty(t)&&i.hasOwnProperty(t))return e.parent.write(e,"(");t=t.slice(1)}}}createLeftOf(e){super.createLeftOf(e),this.checkAutoCmds(e),this.autoParenthesize(e)}italicize(e){return this.isItalic=e,this.isPartOfOperator=!e,this.domFrag().toggleClass("mq-operator-name",!e),this}finalizeTree(e,t){this.sharedSiblingMethod(e,t)}siblingDeleted(e,t){this.sharedSiblingMethod(e,t)}siblingCreated(e,t){this.sharedSiblingMethod(e,t)}sharedSiblingMethod(e,t){t!==L&&this[R]instanceof Letter||this.autoUnItalicize(e)}autoUnItalicize(e){var t,r,s,a,n,i,o,l,d,h,c,m=e.autoOperatorNames;if(0!==m._maxLength&&!this.shouldIgnoreSubstitutionInSimpleSubscript(e)){for(t=this.letter,r=this[L];r instanceof Letter;r=r[L])t=r.letter+t;for(s=this[R];s instanceof Letter;s=s[R])t+=s.letter;e=r&&r[R],a=s&&s[L],new Fragment(e||this.parent.getEnd(L),a||this.parent.getEnd(R)).each(function(e){e instanceof Letter&&(e.italicize(!0).domFrag().removeClass("mq-first mq-last mq-followed-by-supsub"),e.ctrlSeq=e.letter)});var u=m._maxLength||0;e:for(n=0,i=r[R]||this.parent.getEnd(L);i&&n<t.length;n+=1,i=i[R])for(o=min(u,t.length-n);0<o;--o)if(p=t.slice(n,n+o),l=void 0,m.hasOwnProperty(p)){for(d=0,h=i;d<o;d+=1,h=h[R])h instanceof Letter&&(h.italicize(!1),l=h);var p,f=BuiltInOpNames.hasOwnProperty(p);i.ctrlSeq=(f?"\\":"\\operatorname{")+i.ctrlSeq,l.ctrlSeq+=f?" ":"}",TwoWordOpNames.hasOwnProperty(p)&&((p=(f=l[L])&&f[L])&&p[L]).domFrag().addClass("mq-last"),this.shouldOmitPadding(i[L])||i.domFrag().addClass("mq-first"),this.shouldOmitPadding(l[R])||(l[R]instanceof SupSub?((c=l[R]).siblingCreated=c.siblingDeleted=function(){c.domFrag().toggleClass("mq-after-operator-name",!(c[R]instanceof Bracket))})():l.domFrag().toggleClass("mq-last",!(l[R]instanceof Bracket))),n+=o-1,i=l;continue e}}}shouldOmitPadding(e){return!e||"."===e.ctrlSeq||e instanceof BinaryOperator||e instanceof SummationNotation}}function defaultAutoOpNames(){for(var e,t,r,s={_maxLength:9},a="arg deg det dim exp gcd hom inf ker lg lim ln log max min sup limsup liminf injlim projlim Pr".split(" "),n=0;n<a.length;n+=1)BuiltInOpNames[a[n]]=s[a[n]]=1;for(e="sin cos tan arcsin arccos arctan sinh cosh tanh sec csc cot coth".split(" "),n=0;n<e.length;n+=1)BuiltInOpNames[e[n]]=1;for(t="sin cos tan sec cosec csc cotan cot ctg".split(" "),n=0;n<t.length;n+=1)s[t[n]]=s["arc"+t[n]]=s[t[n]+"h"]=s["ar"+t[n]+"h"]=s["arc"+t[n]+"h"]=1;for(r="gcf hcf lcm proj span".split(" "),n=0;n<r.length;n+=1)s[r[n]]=1;return s}BuiltInOpNames={},Options.prototype.autoOperatorNames=defaultAutoOpNames(),TwoWordOpNames={limsup:1,liminf:1,projlim:1,injlim:1},baseOptionProcessors.autoOperatorNames=function(e){var t,r,s,a,n,i;if("string"!=typeof e)throw'"'+e+'" not a space-delimited list';if(!/^[a-z\|\-]+(?: [a-z\|\-]+)*$/i.test(e))throw'"'+e+'" not a space-delimited list of letters or "|"';for(t=e.split(" "),r={},a=s=0;a<t.length;a+=1){if((n=t[a]).length<2)throw'"'+n+'" not minimum length of 2';if(n.indexOf("|")<0)s=max(s,(r[n]=n).length);else{if(2<(i=n.split("|")).length)throw'"'+n+'" has more than 1 mathspeak delimiter';if(i[0].length<2)throw'"'+n[0]+'" not minimum length of 2';r[i[0]]=i[1].replace(/-/g," "),s=max(s,i[0].length)}}return r._maxLength=s,r};class OperatorName extends MQSymbol{constructor(e){super(e||"")}createLeftOf(e){for(var t=this.ctrlSeq,r=0;r<t.length;r+=1)new Letter(t.charAt(r)).createLeftOf(e)}parser(){for(var e=this.ctrlSeq,t=new MathBlock,r=0;r<e.length;r+=1)new Letter(e.charAt(r)).adopt(t,t.getEnd(R),0);return Parser.succeed(t.children())}}for(fn in Options.prototype.autoOperatorNames)Options.prototype.autoOperatorNames.hasOwnProperty(fn)&&(LatexCmds[fn]=OperatorName);LatexCmds.operatorname=class extends MathCommand{createLeftOf(){}numBlocks(){return 1}parser(){return latexMathParser.block.map(function(e){var t=!0,r="",e=e.children();return e.each(function(e){e instanceof Letter?r+=e.letter:t=!1}),t&&"ans"===r?AnsBuilder():e})}},LatexCmds.f=class extends Letter{constructor(){super("f"),this.letter="f",this.domView=new DOMView(0,()=>h("var",{class:"mq-f"},[h.text("f")]))}italicize(e){return this.domFrag().eachElement(e=>e.textContent="f"),this.domFrag().toggleClass("mq-f",e),super.italicize(e)}},LatexCmds[" "]=LatexCmds.space=()=>new DigitGroupingChar("\\ ",h("span",{},[h.text(U_NO_BREAK_SPACE)])," "),LatexCmds["."]=()=>new DigitGroupingChar(".",h("span",{class:"mq-digit"},[h.text(".")]),"."),LatexCmds["'"]=LatexCmds.prime=bindVanillaSymbol("'","&prime;","prime"),LatexCmds["″"]=LatexCmds.dprime=bindVanillaSymbol("″","&Prime;","double prime"),LatexCmds.backslash=bindVanillaSymbol("\\backslash ","\\","backslash"),CharCmds["\\"]||(CharCmds["\\"]=LatexCmds.backslash),LatexCmds.$=bindVanillaSymbol("\\$","$","dollar"),LatexCmds.square=bindVanillaSymbol("\\square ","□","square"),LatexCmds.mid=bindVanillaSymbol("\\mid ","∣","mid");class NonSymbolaSymbol extends MQSymbol{constructor(e,t,r){super(e,h("span",{class:"mq-nonSymbola"},[t||h.text(e)]))}}LatexCmds["@"]=()=>new NonSymbolaSymbol("@"),LatexCmds["&"]=()=>new NonSymbolaSymbol("\\&",h.entityText("&amp;"),"and"),LatexCmds["%"]=class extends NonSymbolaSymbol{constructor(){super("\\%",h.text("%"),"percent")}parser(){var e=Parser.optWhitespace,t=Parser.string;return e.then(t("\\operatorname{of}").map(function(){return PercentOfBuilder()})).or(super.parser())}},LatexCmds["∥"]=LatexCmds.parallel=bindVanillaSymbol("\\parallel ","&#x2225;","parallel"),LatexCmds["∦"]=LatexCmds.nparallel=bindVanillaSymbol("\\nparallel ","&#x2226;","not parallel"),LatexCmds["⟂"]=LatexCmds.perp=bindVanillaSymbol("\\perp ","&#x27C2;","perpendicular"),LatexCmds.alpha=LatexCmds.beta=LatexCmds.gamma=LatexCmds.delta=LatexCmds.zeta=LatexCmds.eta=LatexCmds.theta=LatexCmds.iota=LatexCmds.kappa=LatexCmds.mu=LatexCmds.nu=LatexCmds.xi=LatexCmds.rho=LatexCmds.sigma=LatexCmds.tau=LatexCmds.chi=LatexCmds.psi=LatexCmds.omega=e=>new Variable("\\"+e+" ",h.entityText("&"+e+";")),LatexCmds.phi=bindVariable("\\phi ","&#981;","phi"),LatexCmds.phiv=LatexCmds.varphi=bindVariable("\\varphi ","&phi;","phi"),LatexCmds.epsilon=bindVariable("\\epsilon ","&#1013;","epsilon"),LatexCmds.epsiv=LatexCmds.varepsilon=bindVariable("\\varepsilon ","&epsilon;","epsilon"),LatexCmds.piv=LatexCmds.varpi=bindVariable("\\varpi ","&piv;","piv"),LatexCmds.sigmaf=LatexCmds.sigmav=LatexCmds.varsigma=bindVariable("\\varsigma ","&sigmaf;","sigma"),LatexCmds.thetav=LatexCmds.vartheta=LatexCmds.thetasym=bindVariable("\\vartheta ","&thetasym;","theta"),LatexCmds.upsilon=LatexCmds.upsi=bindVariable("\\upsilon ","&upsilon;","upsilon"),LatexCmds.gammad=LatexCmds.Gammad=LatexCmds.digamma=bindVariable("\\digamma ","&#989;","gamma"),LatexCmds.kappav=LatexCmds.varkappa=bindVariable("\\varkappa ","&#1008;","kappa"),LatexCmds.rhov=LatexCmds.varrho=bindVariable("\\varrho ","&#1009;","rho"),LatexCmds.pi=LatexCmds["π"]=()=>new NonSymbolaSymbol("\\pi ",h.entityText("&pi;"),"pi"),LatexCmds.lambda=()=>new NonSymbolaSymbol("\\lambda ",h.entityText("&lambda;"),"lambda"),LatexCmds.Upsilon=LatexCmds.Upsi=LatexCmds.upsih=LatexCmds.Upsih=()=>new MQSymbol("\\Upsilon ",h("var",{style:"font-family: serif"},[h.entityText("&upsih;")]),"capital upsilon"),LatexCmds.Gamma=LatexCmds.Delta=LatexCmds.Theta=LatexCmds.Lambda=LatexCmds.Xi=LatexCmds.Pi=LatexCmds.Sigma=LatexCmds.Phi=LatexCmds.Psi=LatexCmds.Omega=LatexCmds.forall=e=>new VanillaSymbol("\\"+e+" ",h.entityText("&"+e+";"));class LatexFragment extends MathCommand{constructor(e){super(),this.latexStr=e}createLeftOf(e){var t,r=latexMathParser.parse(this.latexStr);r.children().adopt(e.parent,e[L],e[R]),e[L]=r.getEnd(R),domFrag(r.html()).insertBefore(e.domFrag()),r.finalizeInsert(e.options,e),(t=(t=r.getEnd(R))&&t[R])&&t.siblingCreated(e.options,L),(r=(t=r.getEnd(L))&&t[L])&&r.siblingCreated(e.options,R),e.parent.bubble(function(e){e.reflow()})}mathspeak(){return latexMathParser.parse(this.latexStr).mathspeak()}parser(){var e=latexMathParser.parse(this.latexStr).children();return Parser.succeed(e)}}function isBinaryOperator(e){var t;return!!e&&((t=e[L])?!(t instanceof BinaryOperator||/^(\\ )|[,;:\(\[]$/.test(t.ctrlSeq)):!!(e.parent&&e.parent.parent&&e.parent.parent.isStyleBlock())&&isBinaryOperator(e.parent.parent))}LatexCmds["⁰"]=()=>new LatexFragment("^0"),LatexCmds["¹"]=()=>new LatexFragment("^1"),LatexCmds["²"]=()=>new LatexFragment("^2"),LatexCmds["³"]=()=>new LatexFragment("^3"),LatexCmds["⁴"]=()=>new LatexFragment("^4"),LatexCmds["⁵"]=()=>new LatexFragment("^5"),LatexCmds["⁶"]=()=>new LatexFragment("^6"),LatexCmds["⁷"]=()=>new LatexFragment("^7"),LatexCmds["⁸"]=()=>new LatexFragment("^8"),LatexCmds["⁹"]=()=>new LatexFragment("^9"),LatexCmds["¼"]=()=>new LatexFragment("\\frac14"),LatexCmds["½"]=()=>new LatexFragment("\\frac12"),LatexCmds["¾"]=()=>new LatexFragment("\\frac34"),LatexCmds["√"]=()=>new LatexFragment("\\sqrt{}"),PlusMinus=class extends BinaryOperator{constructor(e,t,r){super(e,t,void 0,r,!0)}contactWeld(e,t){this.sharedSiblingMethod(e.options,t)}siblingCreated(e,t){this.sharedSiblingMethod(e,t)}siblingDeleted(e,t){this.sharedSiblingMethod(e,t)}sharedSiblingMethod(e,t){if(t!==R)return this.domFrag().oneElement().className=isBinaryOperator(this)?"mq-binary-operator":"",this}},LatexCmds["+"]=class extends PlusMinus{constructor(){super("+",h.text("+"))}mathspeak(){return isBinaryOperator(this)?"plus":"positive"}};class MinusNode extends PlusMinus{constructor(){super("-",h.entityText("&minus;"))}mathspeak(){return isBinaryOperator(this)?"minus":"negative"}}LatexCmds["−"]=LatexCmds["—"]=LatexCmds["–"]=LatexCmds["-"]=MinusNode,LatexCmds["±"]=LatexCmds.pm=LatexCmds.plusmn=LatexCmds.plusminus=()=>new PlusMinus("\\pm ",h.entityText("&plusmn;"),"plus-or-minus"),LatexCmds.mp=LatexCmds.mnplus=LatexCmds.minusplus=()=>new PlusMinus("\\mp ",h.entityText("&#8723;"),"minus-or-plus"),CharCmds["*"]=LatexCmds.sdot=LatexCmds.cdot=bindBinaryOperator("\\cdot ","&middot;","*","times");class To extends BinaryOperator{constructor(){super("\\to ",h.entityText("&rarr;"),"to")}deleteTowards(e,t){var r;e===L?(r=t[L],new Fragment(r,this).remove(),t[L]=r[L],(new MinusNode).createLeftOf(t),t[L].bubble(function(e){e.reflow()})):super.deleteTowards(e,t)}}LatexCmds["→"]=LatexCmds.to=To;class Inequality extends BinaryOperator{constructor(e,t){var r=t?"Strict":"";super(e["ctrlSeq"+r],h.entityText(e["htmlEntity"+r]),e["text"+r],e["mathspeak"+r]),this.data=e,this.strict=t}swap(e){e=(this.strict=e)?"Strict":"";this.ctrlSeq=this.data["ctrlSeq"+e],this.domFrag().children().replaceWith(domFrag(h.entityText(this.data["htmlEntity"+e]))),this.textTemplate=[this.data["text"+e]],this.mathspeakName=this.data["mathspeak"+e]}deleteTowards(e,t){e!==L||this.strict?super.deleteTowards(e,t):(this.swap(!0),this.bubble(function(e){e.reflow()}))}}less={ctrlSeq:"\\le ",htmlEntity:"&le;",text:"≤",mathspeak:"less than or equal to",ctrlSeqStrict:"<",htmlEntityStrict:"&lt;",textStrict:"<",mathspeakStrict:"less than"},greater={ctrlSeq:"\\ge ",htmlEntity:"&ge;",text:"≥",mathspeak:"greater than or equal to",ctrlSeqStrict:">",htmlEntityStrict:"&gt;",textStrict:">",mathspeakStrict:"greater than"};class Greater extends Inequality{constructor(){super(greater,!0)}createLeftOf(e){var t=e[L];t instanceof BinaryOperator&&"-"===t.ctrlSeq?(t=t,e[L]=t[L],t.remove(),(new To).createLeftOf(e),e[L].bubble(function(e){e.reflow()})):super.createLeftOf(e)}}LatexCmds["<"]=LatexCmds.lt=()=>new Inequality(less,!0),LatexCmds[">"]=LatexCmds.gt=Greater,LatexCmds["≤"]=LatexCmds.le=LatexCmds.leq=()=>new Inequality(less,!1),LatexCmds["≥"]=LatexCmds.ge=LatexCmds.geq=()=>new Inequality(greater,!1),LatexCmds.infty=LatexCmds.infin=LatexCmds.infinity=bindVanillaSymbol("\\infty ","&infin;","infinity"),LatexCmds["≠"]=LatexCmds.ne=LatexCmds.neq=bindBinaryOperator("\\ne ","&ne;","not equal");class Equality extends BinaryOperator{constructor(){super("=",h.text("="),"=","equals")}createLeftOf(e){var t=e[L];t instanceof Inequality&&t.strict?(t.swap(!1),t.bubble(function(e){e.reflow()})):super.createLeftOf(e)}}LatexCmds["="]=Equality,LatexCmds["×"]=LatexCmds.times=LatexCmds.cross=bindBinaryOperator("\\times ","&times;","[x]","times"),LatexCmds["÷"]=LatexCmds.div=LatexCmds.divide=LatexCmds.divides=bindBinaryOperator("\\div ","&divide;","[/]","over");class Sim extends BinaryOperator{constructor(){super("\\sim ",h.text("~"),"~","tilde")}createLeftOf(e){var t;e[L]instanceof Sim?(t=e[L],e[L]=t[L],t.remove(),(new Approx).createLeftOf(e),e[L].bubble(function(e){e.reflow()})):super.createLeftOf(e)}}class Approx extends BinaryOperator{constructor(){super("\\approx ",h.entityText("&approx;"),"≈","approximately equal")}deleteTowards(e,t){var r;e===L?(r=t[L],new Fragment(r,this).remove(),t[L]=r[L],(new Sim).createLeftOf(t),t[L].bubble(function(e){e.reflow()})):super.deleteTowards(e,t)}}LatexCmds.tildeNbsp=bindVanillaSymbol("~",U_NO_BREAK_SPACE," "),LatexCmds.sim=Sim,LatexCmds["≈"]=LatexCmds.approx=Approx,CharCmds["~"]=LatexCmds.sim,LatexCmds["~"]=LatexCmds.tildeNbsp,baseOptionProcessors.interpretTildeAsSim=function(e){e=!!e;return LatexCmds["~"]=e?LatexCmds.sim:LatexCmds.tildeNbsp,e},SVG_SYMBOLS={sqrt:{width:"",html:()=>h("svg",{preserveAspectRatio:"none",viewBox:"0 0 32 54"},[h("path",{d:"M0 33 L7 27 L12.5 47 L13 47 L30 0 L32 0 L13 54 L11 54 L4.5 31 L0 33"})])},"|":{width:".4em",html:()=>h("svg",{preserveAspectRatio:"none",viewBox:"0 0 10 54"},[h("path",{d:"M4.4 0 L4.4 54 L5.6 54 L5.6 0"})])},"[":{width:".55em",html:()=>h("svg",{preserveAspectRatio:"none",viewBox:"0 0 11 24"},[h("path",{d:"M8 0 L3 0 L3 24 L8 24 L8 23 L4 23 L4 1 L8 1"})])},"]":{width:".55em",html:()=>h("svg",{preserveAspectRatio:"none",viewBox:"0 0 11 24"},[h("path",{d:"M3 0 L8 0 L8 24 L3 24 L3 23 L7 23 L7 1 L3 1"})])},"(":{width:".55em",html:()=>h("svg",{preserveAspectRatio:"none",viewBox:"3 0 106 186"},[h("path",{d:"M85 0 A61 101 0 0 0 85 186 L75 186 A75 101 0 0 1 75 0"})])},")":{width:".55em",html:()=>h("svg",{preserveAspectRatio:"none",viewBox:"3 0 106 186"},[h("path",{d:"M24 0 A61 101 0 0 1 24 186 L34 186 A75 101 0 0 0 34 0"})])},"{":{width:".7em",html:()=>h("svg",{preserveAspectRatio:"none",viewBox:"10 0 210 350"},[h("path",{d:"M170 0 L170 6 A47 52 0 0 0 123 60 L123 127 A35 48 0 0 1 88 175 A35 48 0 0 1 123 223 L123 290 A47 52 0 0 0 170 344 L170 350 L160 350 A58 49 0 0 1 102 301 L103 220 A45 40 0 0 0 58 180 L58 170 A45 40 0 0 0 103 130 L103 49 A58 49 0 0 1 161 0"})])},"}":{width:".7em",html:()=>h("svg",{preserveAspectRatio:"none",viewBox:"10 0 210 350"},[h("path",{d:"M60 0 L60 6 A47 52 0 0 1 107 60 L107 127 A35 48 0 0 0 142 175 A35 48 0 0 0 107 223 L107 290 A47 52 0 0 1 60 344 L60 350 L70 350 A58 49 0 0 0 128 301 L127 220 A45 40 0 0 1 172 180 L172 170 A45 40 0 0 1 127 130 L127 49 A58 49 0 0 0 70 0"})])},"&#8741;":{width:".7em",html:()=>h("svg",{preserveAspectRatio:"none",viewBox:"0 0 10 54"},[h("path",{d:"M3.2 0 L3.2 54 L4 54 L4 0 M6.8 0 L6.8 54 L6 54 L6 0"})])},"&lang;":{width:".55em",html:()=>h("svg",{preserveAspectRatio:"none",viewBox:"0 0 10 54"},[h("path",{d:"M6.8 0 L3.2 27 L6.8 54 L7.8 54 L4.2 27 L7.8 0"})])},"&rang;":{width:".55em",html:()=>h("svg",{preserveAspectRatio:"none",viewBox:"0 0 10 54"},[h("path",{d:"M3.2 0 L6.8 27 L3.2 54 L2.2 54 L5.8 27 L2.2 0"})])}};class Style extends MathCommand{constructor(e,t,r,s,a){super(e,new DOMView(1,e=>h.block(t,r,e[0]))),this.ariaLabel=s||e.replace(/^\\/,""),this.mathspeakTemplate=["Start"+this.ariaLabel+",","End"+this.ariaLabel],this.shouldNotSpeakDelimiters=a&&a.shouldNotSpeakDelimiters}mathspeak(r){return!this.shouldNotSpeakDelimiters||r&&r.ignoreShorthand?super.mathspeak():this.foldChildren("",function(e,t){return e+" "+t.mathspeak(r)}).trim()}}function getCtrlSeqsFromBlock(e){if(!e)return"";let t="";return e.eachChild(e=>{void 0!==e.ctrlSeq&&(t+=e.ctrlSeq)}),t}LatexCmds.mathrm=class extends Style{constructor(){super("\\mathrm","span",{class:"mq-roman mq-font"},"Roman Font",{shouldNotSpeakDelimiters:!0})}isTextBlock(){return!0}},LatexCmds.mathit=()=>new Style("\\mathit","i",{class:"mq-font"},"Italic Font"),LatexCmds.mathbf=()=>new Style("\\mathbf","b",{class:"mq-font"},"Bold Font"),LatexCmds.mathsf=()=>new Style("\\mathsf","span",{class:"mq-sans-serif mq-font"},"Serif Font"),LatexCmds.mathtt=()=>new Style("\\mathtt","span",{class:"mq-monospace mq-font"},"Math Text"),LatexCmds.underline=()=>new Style("\\underline","span",{class:"mq-non-leaf mq-underline"},"Underline"),LatexCmds.overline=LatexCmds.bar=()=>new Style("\\overline","span",{class:"mq-non-leaf mq-overline"},"Overline"),LatexCmds.overrightarrow=()=>new Style("\\overrightarrow","span",{class:"mq-non-leaf mq-overarrow mq-arrow-right"},"Over Right Arrow"),LatexCmds.overleftarrow=()=>new Style("\\overleftarrow","span",{class:"mq-non-leaf mq-overarrow mq-arrow-left"},"Over Left Arrow"),LatexCmds.overleftrightarrow=()=>new Style("\\overleftrightarrow ","span",{class:"mq-non-leaf mq-overarrow mq-arrow-leftright"},"Over Left and Right Arrow"),LatexCmds.overarc=()=>new Style("\\overarc","span",{class:"mq-non-leaf mq-overarc"},"Over Arc"),LatexCmds.dot=()=>new MathCommand("\\dot",new DOMView(1,e=>h("span",{class:"mq-non-leaf"},[h("span",{class:"mq-dot-recurring-inner"},[h("span",{class:"mq-dot-recurring"},[h.text(U_DOT_ABOVE)]),h.block("span",{class:"mq-empty-box"},e[0])])]))),LatexCmds.textcolor=class extends MathCommand{setColor(t){this.color=t,this.domView=new DOMView(1,e=>h.block("span",{class:"mq-textcolor",style:"color:"+t},e[0])),this.ariaLabel=t.replace(/^\\/,""),this.mathspeakTemplate=["Start "+this.ariaLabel+",","End "+this.ariaLabel]}latexRecursive(e){this.checkCursorContextOpen(e);var t=this.blocks[0];e.latex+="\\textcolor{"+this.color+"}{",t.latexRecursive(e),e.latex+="}",this.checkCursorContextClose(e)}parser(){var e=Parser.optWhitespace,t=Parser.string,r=Parser.regex;return e.then(t("{")).then(r(/^[#\w\s.,()%-]*/)).skip(t("}")).then(e=>(this.setColor(e),super.parser()))}isStyleBlock(){return!0}},Class=LatexCmds.class=class extends MathCommand{parser(){var e=Parser.string,t=Parser.regex;return Parser.optWhitespace.then(e("{")).then(t(/^[-\w\s\\\xA0-\xFF]*/)).skip(e("}")).then(t=>(this.cls=t||"",this.domView=new DOMView(1,e=>h.block("span",{class:"mq-class "+t},e[0])),this.ariaLabel=t+" class",this.mathspeakTemplate=["Start "+this.ariaLabel+",","End "+this.ariaLabel],super.parser()))}latexRecursive(e){this.checkCursorContextOpen(e);var t=this.blocks[0];e.latex+="\\class{"+this.cls+"}{",t.latexRecursive(e),e.latex+="}",this.checkCursorContextClose(e)}isStyleBlock(){return!0}},intRgx=/^[\+\-]?[\d]+$/,Options.prototype.charsThatBreakOutOfSupSub="";class SupSub extends MathCommand{constructor(){super(...arguments),this.ctrlSeq="_{...}^{...}"}setEnds(e){pray("SupSub ends must be MathBlocks",e[L]instanceof MathBlock&&e[R]instanceof MathBlock),this.ends=e}getEnd(e){return this.ends[e]}createLeftOf(e){if(this.replacedFragment||e[L]||!e.options.supSubsRequireOperand)return super.createLeftOf(e)}contactWeld(t){for(var r,s,a,n,i=L;i;i=i===L&&R){var o=this[i];let e;if(o instanceof SupSub){for(r="sub";r;r="sub"===r&&"sup")s=this[r],a=o[r],s&&(a?s.isEmpty()?e=new Point(a,0,a.getEnd(L)):(s.domFrag().children().insAtDirEnd(-i,a.domFrag().oneElement()),n=s.children().disown(),e=new Point(a,n.getEnd(R),a.getEnd(L)),i===L?n.adopt(a,a.getEnd(R),0):n.adopt(a,0,a.getEnd(L))):o.addBlock(s.disown()),this.placeCursor=function(t,r){return function(e){e.insAtDirEnd(-i,t||r)}}(a,s));this.remove(),t&&t[L]===this&&(i===R&&e?e[L]?t.insRightOf(e[L]):t.insAtLeftEnd(e.parent):t.insRightOf(o));break}}}finalizeTree(){this.getEnd(L).write=function(e,t){var r;e.options.autoSubscriptNumerals&&this===this.parent.sub&&0<="0123456789".indexOf(t)?((r=this.chToCmd(t,e.options))instanceof MQSymbol?e.deleteSelection():e.clearSelection().insRightOf(this.parent),r.createLeftOf(e.show()),e.controller.aria.queue("Baseline").alert(r.mathspeak({createdLeftOf:e}))):(e[L]&&!e[R]&&!e.selection&&-1<e.options.charsThatBreakOutOfSupSub.indexOf(t)&&(e.insRightOf(this.parent),e.controller.aria.queue("Baseline")),MathBlock.prototype.write.call(this,e,t))}}moveTowards(e,t,r){t.options.autoSubscriptNumerals&&!this.sup?t.insDirOf(e,this):super.moveTowards(e,t,r)}deleteTowards(e,t){var r;t.options.autoSubscriptNumerals&&this.sub?((r=this.sub.getEnd(-e))instanceof MQSymbol?r.remove():r&&r.deleteTowards(e,t.insAtDirEnd(-e,this.sub)),this.sub.isEmpty()&&(this.sub.deleteOutOf(L,t.insAtLeftEnd(this.sub)),this.sup)&&t.insDirOf(-e,this)):super.deleteTowards(e,t)}latexRecursive(e){var t;this.checkCursorContextOpen(e),this.sub&&(e.latex+="_{",t=e.latex.length,this.sub.latexRecursive(e),t===e.latex.length&&(e.latex+=" "),e.latex+="}"),this.sup&&(e.latex+="^{",t=e.latex.length,this.sup.latexRecursive(e),t===e.latex.length&&(e.latex+=" "),e.latex+="}"),this.checkCursorContextClose(e)}text(){function e(e,t){var r=t&&t.text()||"";return t?e+(1===r.length?r:"("+(r||" ")+")"):""}return e("_",this.sub)+e("^",this.sup)}addBlock(e){"sub"===this.supsub?((this.sup=this.upInto=this.sub.upOutOf=e).adopt(this,this.sub,0).downOutOf=this.sub,e.setDOM(domFrag(h("span",{class:"mq-sup"})).append(e.domFrag().children()).prependTo(this.domFrag().oneElement()).oneElement()),NodeBase.linkElementByBlockNode(e.domFrag().oneElement(),e)):((this.sub=this.downInto=this.sup.downOutOf=e).adopt(this,0,this.sup).upOutOf=this.sup,this.domFrag().removeClass("mq-sup-only"),e.setDOM(domFrag(h("span",{class:"mq-sub"})).append(e.domFrag().children()).appendTo(this.domFrag().oneElement()).oneElement()),NodeBase.linkElementByBlockNode(e.domFrag().oneElement(),e),this.domFrag().append(domFrag(h("span",{style:"display:inline-block;width:0"},[h.text(U_ZERO_WIDTH_SPACE)]))));for(var t=0;t<2;t+=1)!function(s,a,n,i){s[a].deleteOutOf=function(e,t){t.insDirOf(this[e]?-e:e,this.parent),this.isEmpty()||(r=this.getEnd(e),this.children().disown().withDirAdopt(e,t.parent,t[e],t[-e]).domFrag().insDirOf(-e,t.domFrag()),t[-e]=r),s.supsub=n,delete s[a],delete s[i+"Into"];var r,t=s[n];t[i+"OutOf"]=insLeftOfMeUnlessAtEnd,delete t.deleteOutOf,"sub"===a&&s.domFrag().addClass("mq-sup-only").children().last().remove(),this.remove()}}(this,"sub sup".split(" ")[t],"sup sub".split(" ")[t],"down up".split(" ")[t])}}function insLeftOfMeUnlessAtEnd(e){var t=this.parent,r=e;do{if(r[R])return e.insLeftOf(t)}while((r=r.parent.parent)!==t);e.insRightOf(t)}class SubscriptCommand extends SupSub{constructor(){super(...arguments),this.supsub="sub",this.domView=new DOMView(1,e=>h("span",{class:"mq-supsub mq-non-leaf"},[h.block("span",{class:"mq-sub"},e[0]),h("span",{style:"display:inline-block;width:0"},[h.text(U_ZERO_WIDTH_SPACE)])])),this.textTemplate=["_"],this.mathspeakTemplate=["Subscript,",", Baseline"],this.ariaLabel="subscript"}finalizeTree(){this.downInto=this.sub=this.getEnd(L),this.sub.upOutOf=insLeftOfMeUnlessAtEnd,super.finalizeTree()}}LatexCmds.subscript=LatexCmds._=SubscriptCommand,LatexCmds.superscript=LatexCmds.supscript=LatexCmds["^"]=class extends SupSub{constructor(){super(...arguments),this.supsub="sup",this.domView=new DOMView(1,e=>h("span",{class:"mq-supsub mq-non-leaf mq-sup-only"},[h.block("span",{class:"mq-sup"},e[0])])),this.textTemplate=["^(",")"],this.ariaLabel="superscript",this.mathspeakTemplate=["Superscript,",", Baseline"]}mathspeak(e){var t,r=this.upInto;return void 0===r||(t=getCtrlSeqsFromBlock(r),e&&e.ignoreShorthand)||!intRgx.test(t)?super.mathspeak():"0"===t?"to the 0 power":"2"===t?"squared":"3"===t?"cubed":(e="",/^[+-]?\d{1,3}$/.test(t)&&(/(11|12|13|4|5|6|7|8|9|0)$/.test(t)?e="th":/1$/.test(t)?e="st":/2$/.test(t)?e="nd":/3$/.test(t)&&(e="rd")),"to the "+("object"==typeof r?r.mathspeak():t)+e+" power")}finalizeTree(){this.upInto=this.sup=this.getEnd(R),this.sup.downOutOf=insLeftOfMeUnlessAtEnd,super.finalizeTree()}};class SummationNotation extends MathCommand{constructor(e,t,r){super(),this.ariaLabel=r||e.replace(/^\\/,"");r=new DOMView(2,e=>h("span",{class:"mq-large-operator mq-non-leaf"},[h("span",{class:"mq-to"},[h.block("span",{},e[1])]),h("big",{},[h.text(t)]),h("span",{class:"mq-from"},[h.block("span",{},e[0])])]));MQSymbol.prototype.setCtrlSeqHtmlTextAndMathspeak.call(this,e,r)}createLeftOf(e){super.createLeftOf(e),e.options.sumStartsWithNEquals&&(new Letter("n").createLeftOf(e),(new Equality).createLeftOf(e))}latexRecursive(e){this.checkCursorContextOpen(e),e.latex+=this.ctrlSeq+"_{";var t=e.latex.length,r=(this.getEnd(L).latexRecursive(e),e.latex.length);r===t&&(e.latex+=" "),e.latex+="}^{",t=e.latex.length,this.getEnd(R).latexRecursive(e),t===(r=e.latex.length)&&(e.latex+=" "),e.latex+="}",this.checkCursorContextClose(e)}mathspeak(){return"Start "+this.ariaLabel+" from "+this.getEnd(L).mathspeak()+" to "+this.getEnd(R).mathspeak()+", end "+this.ariaLabel+", "}parser(){for(var e=Parser.string,t=Parser.optWhitespace,r=Parser.succeed,s=latexMathParser.block,a=this,n=a.blocks=[new MathBlock,new MathBlock],i=0;i<n.length;i+=1)n[i].adopt(a,a.getEnd(R),0);return t.then(e("_").or(e("^"))).then(function(e){var t=n["_"===e?0:1];return s.then(function(e){return e.children().adopt(t,t.getEnd(R),0),r(a)})}).many().result(a)}finalizeTree(){var e=this.getEnd(L),t=this.getEnd(R);e.ariaLabel="lower bound",t.ariaLabel="upper bound",this.downInto=e,this.upInto=t,(e.upOutOf=t).downOutOf=e}}LatexCmds["∑"]=LatexCmds.sum=LatexCmds.summation=()=>new SummationNotation("\\sum ",U_NARY_SUMMATION,"sum"),LatexCmds["∏"]=LatexCmds.prod=LatexCmds.product=()=>new SummationNotation("\\prod ",U_NARY_PRODUCT,"product"),LatexCmds.coprod=LatexCmds.coproduct=()=>new SummationNotation("\\coprod ",U_NARY_COPRODUCT,"co product"),LatexCmds["∫"]=LatexCmds.int=LatexCmds.integral=class extends SummationNotation{constructor(){super("\\int ","","integral"),this.ariaLabel="integral",this.domView=new DOMView(2,e=>h("span",{class:"mq-int mq-non-leaf"},[h("big",{},[h.text(U_INTEGRAL)]),h("span",{class:"mq-supsub mq-non-leaf"},[h("span",{class:"mq-sup"},[h.block("span",{class:"mq-sup-inner"},e[1])]),h.block("span",{class:"mq-sub"},e[0]),h("span",{style:"display:inline-block;width:0"},[h.text(U_ZERO_WIDTH_SPACE)])])]))}createLeftOf(e){MathCommand.prototype.createLeftOf.call(this,e)}},Fraction=LatexCmds.frac=LatexCmds.dfrac=LatexCmds.cfrac=LatexCmds.fraction=class extends MathCommand{constructor(){super(...arguments),this.ctrlSeq="\\frac",this.domView=new DOMView(2,e=>h("span",{class:"mq-fraction mq-non-leaf"},[h.block("span",{class:"mq-numerator"},e[0]),h.block("span",{class:"mq-denominator"},e[1]),h("span",{style:"display:inline-block;width:0"},[h.text(U_ZERO_WIDTH_SPACE)])])),this.textTemplate=["(",")/(",")"]}finalizeTree(){var e=this.getEnd(L),t=this.getEnd(R);this.upInto=t.upOutOf=e,this.downInto=e.downOutOf=t,e.ariaLabel="numerator",t.ariaLabel="denominator",1<this.getFracDepth()?this.mathspeakTemplate=["StartNestedFraction,","NestedOver",", EndNestedFraction"]:this.mathspeakTemplate=["StartFraction,","Over",", EndFraction"]}mathspeak(e){var t,r,s,a,n;if(e&&e.createdLeftOf)return e.createdLeftOf.parent.mathspeak();if(s=getCtrlSeqsFromBlock(this.getEnd(L)),t=getCtrlSeqsFromBlock(this.getEnd(R)),e&&e.ignoreShorthand||!intRgx.test(s)||!intRgx.test(t)||(e="1"===s||"-1"===s,r="","2"===t?r=e?"half":"halves":"3"===t?r=e?"third":"thirds":"4"===t?r=e?"quarter":"quarters":"5"===t?r=e?"fifth":"fifths":"6"===t?r=e?"sixth":"sixths":"7"===t?r=e?"seventh":"sevenths":"8"===t?r=e?"eighth":"eighths":"9"===t&&(r=e?"ninth":"ninths"),""===r))return super.mathspeak();for(s="",a=!1,n=this[L];n&&void 0!==n[L];n=n[L])if("\\ "!==n.ctrlSeq){if(!intRgx.test(n.ctrlSeq||"")){a=!1;break}a=!0}return a&&(s+="and "),s+=this.getEnd(L).mathspeak()+" "+r}getFracDepth(){var r=function(e,t){return e instanceof MQNode&&e.ctrlSeq&&0<=e.ctrlSeq.toLowerCase().search("frac")&&(t+=1),e&&e.parent?r(e.parent,t):t};return r(this,0)}},LiveFraction=LatexCmds.over=CharCmds["/"]=class extends Fraction{createLeftOf(e){if(!this.replacedFragment){var t,r,s=e[L];if(!e.options.typingSlashCreatesNewFraction)for(;s&&!(s instanceof BinaryOperator||s instanceof(LatexCmds.text||noop)||s instanceof SummationNotation||"\\ "===s.ctrlSeq||/^[,;:]$/.test(s.ctrlSeq));)s=s[L];(s=s instanceof SummationNotation&&s[R]instanceof SupSub&&(t=(s=s[R])[R])instanceof SupSub&&t.ctrlSeq!=s.ctrlSeq?s[R]:s)===e[L]||e.isTooDeep(1)||(t=s[R],r=e[L],this.replaces(new Fragment(t||e.parent.getEnd(L),r)),e[L]=s)}super.createLeftOf(e)}};const AnsBuilder=()=>new MQSymbol("\\operatorname{ans}",h("span",{class:"mq-ans"},[h.text("ans")]),"ans"),PercentOfBuilder=(LatexCmds.ans=AnsBuilder,()=>new MQSymbol("\\%\\operatorname{of}",h("span",{class:"mq-nonSymbola mq-operator-name"},[h.text("% of ")]),"percent of"));LatexCmds.percent=LatexCmds.percentof=PercentOfBuilder;class Token extends MQSymbol{constructor(){super(...arguments),this.tokenId="",this.ctrlSeq="\\token",this.textTemplate=["token(",")"],this.mathspeakTemplate=["StartToken,",", EndToken"],this.ariaLabel="token"}html(){var e=h("span",{class:"mq-token mq-ignore-mousedown","data-mq-token":this.tokenId});return this.setDOM(e),NodeBase.linkElementByCmdNode(e,this),e}latexRecursive(e){this.checkCursorContextOpen(e),e.latex+="\\token{"+this.tokenId+"}",this.checkCursorContextClose(e)}mathspeak(){let t=[];return this.domFrag().children().eachElement(e=>{e=e.getAttribute("aria-label");"string"==typeof e&&""!==e&&t.push(e)}),0<t.length?t.join(" ").trim():"token "+this.tokenId}parser(){var r=this;return latexMathParser.block.map(function(e){var t=e.getEnd(L);if(t)for(r.tokenId+=t.ctrlSeq;t=t[R];)r.tokenId+=t.ctrlSeq;return r})}}LatexCmds.token=Token;class SquareRoot extends MathCommand{constructor(){super(...arguments),this.ctrlSeq="\\sqrt",this.domView=new DOMView(1,e=>h("span",{class:"mq-non-leaf mq-sqrt-container"},[h("span",{class:"mq-scaled mq-sqrt-prefix"},[SVG_SYMBOLS.sqrt.html()]),h.block("span",{class:"mq-non-leaf mq-sqrt-stem"},e[0])])),this.textTemplate=["sqrt(",")"],this.mathspeakTemplate=["StartRoot,",", EndRoot"],this.ariaLabel="root"}parser(){return latexMathParser.optBlock.then(function(r){return latexMathParser.block.map(function(e){var t=new NthRoot;return t.blocks=[r,e],r.adopt(t,0,0),e.adopt(t,r,0),t})}).or(super.parser())}}LatexCmds.sqrt=SquareRoot,LatexCmds.hat=class extends MathCommand{constructor(){super(...arguments),this.ctrlSeq="\\hat",this.domView=new DOMView(1,e=>h("span",{class:"mq-non-leaf"},[h("span",{class:"mq-hat-prefix"},[h.text("^")]),h.block("span",{class:"mq-hat-stem"},e[0])])),this.textTemplate=["hat(",")"]}};class NthRoot extends SquareRoot{constructor(){super(...arguments),this.domView=new DOMView(2,e=>h("span",{class:"mq-nthroot-container mq-non-leaf"},[h.block("sup",{class:"mq-nthroot mq-non-leaf"},e[0]),h("span",{class:"mq-scaled mq-sqrt-container"},[h("span",{class:"mq-sqrt-prefix mq-scaled"},[SVG_SYMBOLS.sqrt.html()]),h.block("span",{class:"mq-sqrt-stem mq-non-leaf"},e[1])])])),this.textTemplate=["sqrt[","](",")"]}latexRecursive(e){this.checkCursorContextOpen(e),e.latex+="\\sqrt[",this.getEnd(L).latexRecursive(e),e.latex+="]{",this.getEnd(R).latexRecursive(e),e.latex+="}",this.checkCursorContextClose(e)}mathspeak(){var e=this.getEnd(L).mathspeak(),t=this.getEnd(R).mathspeak();return this.getEnd(L).ariaLabel="Index",this.getEnd(R).ariaLabel="Radicand","3"===e?"Start Cube Root, "+t+", End Cube Root":"Root Index "+e+", Start Root, "+t+", End Root"}}LatexCmds.nthroot=NthRoot,LatexCmds.cbrt=class extends NthRoot{createLeftOf(e){super.createLeftOf(e),new Digit("3").createLeftOf(e),e.controller.moveRight()}};class DiacriticAbove extends MathCommand{constructor(e,t,r){super(e,new DOMView(1,e=>h("span",{class:"mq-non-leaf"},[h("span",{class:"mq-diacritic-above"},[t]),h.block("span",{class:"mq-diacritic-stem"},e[0])])),r)}}LatexCmds.vec=()=>new DiacriticAbove("\\vec",h.entityText("&rarr;"),["vec(",")"]),LatexCmds.tilde=()=>new DiacriticAbove("\\tilde",h.text("~"),["tilde(",")"]);class DelimsNode extends MathCommand{setDOM(e){super.setDOM(e);e=this.domFrag().children();return e.isEmpty()||(this.delimFrags={[L]:e.first(),[R]:e.last()}),this}}class Bracket extends DelimsNode{constructor(e,t,r,s,a){super("\\left"+s,void 0,[t,r]),this.side=e,this.sides={[L]:{ch:t,ctrlSeq:s},[R]:{ch:r,ctrlSeq:a}}}numBlocks(){return 1}html(){var t=this.getSymbol(L),r=this.getSymbol(R);return this.domView=new DOMView(1,e=>h("span",{class:"mq-non-leaf mq-bracket-container"},[h("span",{style:"width:"+t.width,class:"mq-scaled mq-bracket-l mq-paren"+(this.side===R?" mq-ghost":"")},[t.html()]),h.block("span",{style:"margin-left:"+t.width+";margin-right:"+r.width,class:"mq-bracket-middle mq-non-leaf"},e[0]),h("span",{style:"width:"+r.width,class:"mq-scaled mq-bracket-r mq-paren"+(this.side===L?" mq-ghost":"")},[r.html()])])),super.html()}getSymbol(e){e=this.sides[e||R].ch;return SVG_SYMBOLS[e]||{width:"0",html:""}}latexRecursive(e){this.checkCursorContextOpen(e),e.latex+="\\left"+this.sides[L].ctrlSeq,this.getEnd(L).latexRecursive(e),e.latex+="\\right"+this.sides[R].ctrlSeq,this.checkCursorContextClose(e)}mathspeak(e){var t=this.sides[L].ch,r=this.sides[R].ch;if("|"===t&&"|"===r)this.mathspeakTemplate=["StartAbsoluteValue,",", EndAbsoluteValue"],this.ariaLabel="absolute value";else{if(e&&e.createdLeftOf&&this.side)return e="",this.side===L?e=this.textTemplate[0]:this.side===R&&(e=this.textTemplate[1]),(this.side===L?"left ":"right ")+BRACKET_NAMES[e];this.mathspeakTemplate=["left "+BRACKET_NAMES[t]+",",", right "+BRACKET_NAMES[r]],this.ariaLabel=BRACKET_NAMES[t]+" block"}return super.mathspeak()}matchBrack(e,t,r){return r instanceof Bracket&&r.side&&r.side!==-t&&(!e.restrictMismatchedBrackets||OPP_BRACKS[this.sides[this.side].ch]===r.sides[r.side].ch||{"(":"]","[":")"}[this.sides[L].ch]===r.sides[R].ch)&&r}closeOpposing(e){e.side=0,e.sides[this.side]=this.sides[this.side];e=e.delimFrags[this.side===L?L:R].removeClass("mq-ghost");this.replaceBracket(e,this.side)}createLeftOf(e){var t,r;this.replacedFragment||(t=e.options,t="|"===this.sides[L].ch?this.matchBrack(t,R,e[R])||this.matchBrack(t,L,e[L])||this.matchBrack(t,0,e.parent.parent):this.matchBrack(t,-this.side,e[-this.side])||this.matchBrack(t,-this.side,e.parent.parent)),t?(r=this.side=-t.side,this.closeOpposing(t),t===e.parent.parent&&e[r]&&new Fragment(e[r],e.parent.getEnd(r),-r).disown().withDirAdopt(-r,t.parent,t,t[r]).domFrag().insDirOf(r,t.domFrag()),t.bubble(function(e){e.reflow()})):(r=(t=this).side,t.replacedFragment?t.side=0:e[-r]&&(t.replaces(new Fragment(e[-r],e.parent.getEnd(-r),r)),e[-r]=0),super.createLeftOf(e)),r===L?e.insAtLeftEnd(t.getEnd(L)):e.insRightOf(t)}placeCursor(){}unwrap(){this.getEnd(L).children().disown().adopt(this.parent,this,this[R]).domFrag().insertAfter(this.domFrag()),this.remove()}deleteSide(e,t,r){var s,a,n=this.parent,i=this[e],o=n.getEnd(e);if(e===this.side)this.unwrap(),i?r.insDirOf(-e,i):r.insAtDirEnd(e,n);else if(l=r.options,s=!this.side,this.side=-e,this.matchBrack(l,e,this.getEnd(L).getEnd(this.side)))this.closeOpposing(this.getEnd(L).getEnd(this.side)),a=this.getEnd(L).getEnd(e),this.unwrap(),a&&a.siblingCreated(r.options,e),i?r.insDirOf(-e,i):r.insAtDirEnd(e,n);else{if(this.matchBrack(l,e,this.parent.parent))this.parent.parent.closeOpposing(this),this.parent.parent.unwrap();else{if(t&&s)return this.unwrap(),void(i?r.insDirOf(-e,i):r.insAtDirEnd(e,n));this.sides[e]=getOppBracketSide(this),this.delimFrags[L].removeClass("mq-ghost"),this.delimFrags[R].removeClass("mq-ghost");var l=this.delimFrags[e].addClass("mq-ghost");this.replaceBracket(l,e)}i?(a=(s=this.getEnd(L)).getEnd(e),s.domFrag().removeClass("mq-empty"),new Fragment(i,o,-e).disown().withDirAdopt(-e,s,a,0).domFrag().insAtDirEnd(e,s.domFrag().oneElement()),a&&a.siblingCreated(r.options,e),r.insDirOf(-e,i)):t?r.insDirOf(e,this):r.insAtDirEnd(e,this.getEnd(L))}}replaceBracket(e,t){var r=this.getSymbol(t);e.children().replaceWith(domFrag(r.html())),e.oneElement().style.width=r.width,t===L?(t=e.next()).isEmpty()||(t.oneElement().style.marginLeft=r.width):(t=e.prev()).isEmpty()||(t.oneElement().style.marginRight=r.width)}deleteTowards(e,t){this.deleteSide(-e,!1,t)}finalizeTree(){this.getEnd(L).deleteOutOf=function(e,t){this.parent.deleteSide(e,!0,t)},this.finalizeTree=this.intentionalBlur=function(){this.delimFrags[this.side===L?R:L].removeClass("mq-ghost"),this.side=0}}siblingCreated(e,t){t===-this.side&&this.finalizeTree()}}function getOppBracketSide(e){var t=e.side,e=e.sides[t];return{ch:OPP_BRACKS[e.ch],ctrlSeq:OPP_BRACKS[e.ctrlSeq]}}function bindCharBracketPair(e,t,r){var s,a;t=t||e,s=OPP_BRACKS[e],a=OPP_BRACKS[t],CharCmds[e]=()=>new Bracket(L,e,s,t,a),CharCmds[s]=()=>new Bracket(R,e,s,t,a),BRACKET_NAMES[e]=BRACKET_NAMES[s]=r}OPP_BRACKS={"(":")",")":"(","[":"]","]":"[","{":"}","}":"{","\\{":"\\}","\\}":"\\{","&lang;":"&rang;","&rang;":"&lang;","\\langle ":"\\rangle ","\\rangle ":"\\langle ","|":"|","\\lVert ":"\\rVert ","\\rVert ":"\\lVert "},BRACKET_NAMES={"&lang;":"angle-bracket","&rang;":"angle-bracket","|":"pipe"},bindCharBracketPair("(","","parenthesis"),bindCharBracketPair("[","","bracket"),bindCharBracketPair("{","\\{","brace"),LatexCmds.langle=()=>new Bracket(L,"&lang;","&rang;","\\langle ","\\rangle "),LatexCmds.rangle=()=>new Bracket(R,"&lang;","&rang;","\\langle ","\\rangle "),CharCmds["|"]=()=>new Bracket(L,"|","|","|","|"),LatexCmds.lVert=()=>new Bracket(L,"&#8741;","&#8741;","\\lVert ","\\rVert "),LatexCmds.rVert=()=>new Bracket(R,"&#8741;","&#8741;","\\lVert ","\\rVert "),LatexCmds.left=class extends MathCommand{parser(){var e=Parser.regex,t=Parser.string,n=Parser.optWhitespace;return n.then(e(/^(?:[([|]|\\\{|\\langle(?![a-zA-Z])|\\lVert(?![a-zA-Z]))/)).then(function(s){var a=s.replace(/^\\/,"");return"\\langle"==s&&(a="&lang;",s+=" "),"\\lVert"==s&&(a="&#8741;",s+=" "),latexMathParser.then(function(r){return t("\\right").skip(n).then(e(/^(?:[\])|]|\\\}|\\rangle(?![a-zA-Z])|\\rVert(?![a-zA-Z]))/)).map(function(e){var t=e.replace(/^\\/,"");return"\\rangle"==e&&(t="&rang;",e+=" "),"\\rVert"==e&&(t="&#8741;",e+=" "),(t=new Bracket(0,a,t,s,e)).blocks=[r],r.adopt(t,0,0),t})})})}},LatexCmds.right=class extends MathCommand{parser(){return Parser.fail("unmatched \\right")}},leftBinomialSymbol=SVG_SYMBOLS["("],rightBinomialSymbol=SVG_SYMBOLS[")"];class Binomial extends DelimsNode{constructor(){super(...arguments),this.ctrlSeq="\\binom",this.domView=new DOMView(2,e=>h("span",{class:"mq-non-leaf mq-bracket-container"},[h("span",{style:"width:"+leftBinomialSymbol.width,class:"mq-paren mq-bracket-l mq-scaled"},[leftBinomialSymbol.html()]),h("span",{style:"margin-left:"+leftBinomialSymbol.width+"; margin-right:"+rightBinomialSymbol.width,class:"mq-non-leaf mq-bracket-middle"},[h("span",{class:"mq-array mq-non-leaf"},[h.block("span",{},e[0]),h.block("span",{},e[1])])]),h("span",{style:"width:"+rightBinomialSymbol.width,class:"mq-paren mq-bracket-r mq-scaled"},[rightBinomialSymbol.html()])])),this.textTemplate=["choose(",",",")"],this.mathspeakTemplate=["StartBinomial,","Choose",", EndBinomial"],this.ariaLabel="binomial"}}LatexCmds.binom=LatexCmds.binomial=Binomial,LatexCmds.choose=class extends Binomial{createLeftOf(e){LiveFraction.prototype.createLeftOf(e)}};class MathFieldNode extends MathCommand{constructor(){super(...arguments),this.ctrlSeq="\\MathQuillMathField",this.domView=new DOMView(1,e=>h("span",{class:"mq-editable-field"},[h.block("span",{class:"mq-root-block","aria-hidden":"true"},e[0])]))}parser(){var t=this,e=Parser.string,r=Parser.regex,s=Parser.succeed;return e("[").then(r(/^[a-z][a-z0-9]*/i)).skip(e("]")).map(function(e){t.name=e}).or(s(void 0)).then(super.parser())}finalizeTree(e){e=new Controller(this.getEnd(L),this.domFrag().oneElement(),e);e.KIND_OF_MQ="MathField",e.editable=!0,e.createTextarea(),e.editablesTextareaEvents(),e.cursor.insAtRightEnd(e.root),RootBlockMixin(e.root),function e(t){var r;t.parentNode&&!domFrag(t).hasClass("mq-root-block")&&e(t.parentNode),t.nodeType===Node.ELEMENT_NODE&&"true"===(r=t).getAttribute("aria-hidden")&&(r.removeAttribute("aria-hidden"),domFrag(t).children().eachElement(e=>{e.setAttribute("aria-hidden","true")}))}(this.domFrag().parent().oneElement()),this.domFrag().oneElement().removeAttribute("aria-hidden")}registerInnerField(e,t){t=new t(this.getEnd(L).controller);e[this.name]=t,e.push(t)}latexRecursive(e){this.checkCursorContextOpen(e),this.getEnd(L).latexRecursive(e),this.checkCursorContextClose(e)}text(){return this.getEnd(L).text()}}LatexCmds.editable=LatexCmds.MathQuillMathField=MathFieldNode;class EmbedNode extends MQSymbol{setOptions(e){function t(){return""}return this.text=e.text||t,this.domView=new DOMView(0,()=>h("span",{},[parseHTML(e.htmlString||"")])),this.latex=e.latex||t,this}latexRecursive(e){this.checkCursorContextOpen(e),e.latex+=this.latex(),this.checkCursorContextClose(e)}parser(){var r=this,e=Parser.string,s=Parser.regex,a=Parser.succeed;return e("{").then(s(/^[a-z][a-z0-9]*/i)).skip(e("}")).then(function(t){return e("[").then(s(/^[-\w\s]*/)).skip(e("]")).or(a(void 0)).map(function(e){return r.setOptions(EMBEDS[t](e))})})}}LatexCmds.embed=EmbedNode;class TextBlock extends MQNode{constructor(){super(...arguments),this.ctrlSeq="\\text",this.ariaLabel="Text",this.mathspeakTemplate=["StartText","EndText"]}replaces(e){e instanceof Fragment?this.replacedText=e.remove().domFrag().text():"string"==typeof e&&(this.replacedText=e)}setDOMFrag(e){super.setDOM(e);var t,e=this.getEnd(L);return e&&!(t=this.domFrag().children()).isEmpty()&&e.setDOM(t.oneText()),this}createLeftOf(e){var t,r=this;if(super.createLeftOf(e),e.insAtRightEnd(r),r.replacedText)for(t=0;t<r.replacedText.length;t+=1)r.write(e,r.replacedText.charAt(t));var s=r[R],s=(s&&s.siblingCreated(e.options,L),r[L]);s&&s.siblingCreated(e.options,R),r.bubble(function(e){e.reflow()})}parser(){var t=this,e=Parser.string,r=Parser.regex;return Parser.optWhitespace.then(e("{")).then(r(/^[^}]*/)).skip(e("}")).map(function(e){return 0===e.length?new Fragment(0,0):(new TextPiece(e).adopt(t,0,0),t)})}textContents(){return this.foldChildren("",function(e,t){return e+t.textStr})}text(){return'"'+this.textContents()+'"'}latexRecursive(e){this.checkCursorContextOpen(e);var t=this.textContents();0<t.length&&(e.latex+=this.ctrlSeq+"{",e.latex+=t.replace(/\\/g,"\\backslash ").replace(/[{}]/g,"\\$&"),e.latex+="}"),this.checkCursorContextClose(e)}html(){var e=h("span",{class:"mq-text-mode"},[h.text(this.textContents())]);return this.setDOM(e),NodeBase.linkElementByCmdNode(e,this),e}mathspeak(e){return e&&e.ignoreShorthand?this.mathspeakTemplate[0]+", "+this.textContents()+", "+this.mathspeakTemplate[1]:this.textContents()}isTextBlock(){return!0}moveTowards(e,t){t.insAtDirEnd(-e,this),t.controller.aria.queueDirEndOf(-e).queue(t.parent,!0)}moveOutOf(e,t){t.insDirOf(e,this),t.controller.aria.queueDirOf(e).queue(this)}unselectInto(e,t){this.moveTowards(e,t)}selectTowards(e,t){MathCommand.prototype.selectTowards.call(this,e,t)}deleteTowards(e,t){MathCommand.prototype.deleteTowards.call(this,e,t)}selectOutOf(e,t){t.insDirOf(e,this)}deleteOutOf(e,t){this.isEmpty()&&t.insRightOf(this)}write(e,t){var r,s;e.show().deleteSelection(),"$"!==t?(s=e[L])?s instanceof TextPiece&&s.appendText(t):new TextPiece(t).createLeftOf(e):this.isEmpty()?(e.insRightOf(this),new VanillaSymbol("\\$",h.text("$")).createLeftOf(e)):e[R]?e[L]?(s=new TextBlock,(r=this.getEnd(L))&&(r.disown().domFrag().detach(),r.adopt(s,0,0)),e.insLeftOf(this),super.createLeftOf.call(s,e)):e.insLeftOf(this):e.insRightOf(this),this.bubble(function(e){e.reflow()}),e.controller.aria.alert(t)}writeLatex(e,t){var r=e[L];r?r instanceof TextPiece&&r.appendText(t):new TextPiece(t).createLeftOf(e),this.bubble(function(e){e.reflow()})}seek(e,t){var r,s,a;if(t.hide(),i=TextBlockFuseChildren(this)){var n,i,o=this.domFrag().children().oneText(),l=document.createRange();for(l.selectNodeContents(o),1!==(o=l.getClientRects()).length||({width:l,left:o}=o[0],l=l/this.textContents().length,(o=Math.round((e-o)/l))<=0)?t.insAtLeftEnd(this):o>=i.textStr.length?t.insAtRightEnd(this):t.insLeftOf(i.splitRight(o)),a=s=(r=e-t.show().getBoundingClientRectWithoutMargin().left)&&r<0?L:R;t[s]&&0<r*a;)t[s].moveTowards(s,t),a=r,r=e-t.getBoundingClientRectWithoutMargin().left;s*r<-s*a&&t[-s].moveTowards(-s,t),t.anticursor?t.anticursor.parent===this&&(i=(l=t[L])&&l.textStr.length,this.anticursorPosition===i?t.anticursor=Anticursor.fromCursor(t):(this.anticursorPosition<i?(n=l.splitRight(this.anticursorPosition),t[L]=n):n=t[R].splitRight(this.anticursorPosition-i),t.anticursor=new Anticursor(this,n[L],n))):(o=t[L],this.anticursorPosition=o&&o.textStr.length)}}blur(e){MathBlock.prototype.blur.call(this,e),e&&(""===this.textContents()?(this.remove(),e[L]===this?e[L]=this[L]:e[R]===this&&(e[R]=this[R])):TextBlockFuseChildren(this))}focus(){MathBlock.prototype.focus.call(this)}}function TextBlockFuseChildren(e){e.domFrag().oneElement().normalize();var t,r=e.domFrag().children();if(!r.isEmpty())return pray("only node in TextBlock span is Text node",3===(r=r.oneText()).nodeType),(t=new TextPiece(r.data)).setDOM(r),e.children().disown(),t.adopt(e,0,0),t}class TextPiece extends MQNode{constructor(e){super(),this.textStr=e}html(){var e=h.text(this.textStr);return this.setDOM(e),e}appendText(e){this.textStr+=e,this.domFrag().oneText().appendData(e)}prependText(e){this.textStr=e+this.textStr,this.domFrag().oneText().insertData(0,e)}insTextAtDirEnd(e,t){prayDirection(t),t===R?this.appendText(e):this.prependText(e)}splitRight(e){var t=new TextPiece(this.textStr.slice(e)).adopt(this.parent,this,this[R]);return t.setDOM(this.domFrag().oneText().splitText(e)),this.textStr=this.textStr.slice(0,e),t}endChar(e,t){return t.charAt(e===L?0:-1+t.length)}moveTowards(e,t){var r,s;return prayDirection(e),r=this.endChar(-e,this.textStr),(s=this[-e])instanceof TextPiece?s.insTextAtDirEnd(r,e):new TextPiece(r).createDir(-e,t),this.deleteTowards(e,t)}mathspeak(){return this.textStr}latexRecursive(e){this.checkCursorContextOpen(e),e.latex+=this.textStr,this.checkCursorContextClose(e)}deleteTowards(e,t){var r;1<this.textStr.length?(e===R?(this.domFrag().oneText().deleteData(0,1),r=this.textStr[0],this.textStr=this.textStr.slice(1)):(this.domFrag().oneText().deleteData(-1+this.textStr.length,1),r=this.textStr[this.textStr.length-1],this.textStr=this.textStr.slice(0,-1)),t.controller.aria.queue(r)):(this.remove(),t[e]=this[e],t.controller.aria.queue(this.textStr))}selectTowards(e,t){var r,s,a,n;if(prayDirection(e),r=t.anticursor)return s=this.endChar(-e,this.textStr),r[e]===this?(a=new TextPiece(s).createDir(e,t),r[e]=a,t.insDirOf(e,a)):((n=this[-e])instanceof TextPiece?n.insTextAtDirEnd(s,e):(a=new TextPiece(s).createDir(-e,t),(n=t.selection)&&a.domFrag().insDirOf(-e,n.domFrag())),1===this.textStr.length&&r[-e]===this&&(r[-e]=this[-e])),this.deleteTowards(e,t)}}function makeTextBlock(e,t,r,s){return class extends TextBlock{constructor(){super(...arguments),this.ctrlSeq=e,this.mathspeakTemplate=["Start"+t,"End"+t],this.ariaLabel=t}html(){var e=h(r,s,[h.text(this.textContents())]);return this.setDOM(e),NodeBase.linkElementByCmdNode(e,this),e}}}LatexCmds.text=LatexCmds.textnormal=LatexCmds.textrm=LatexCmds.textup=LatexCmds.textmd=TextBlock,LatexCmds.em=LatexCmds.italic=LatexCmds.italics=LatexCmds.emph=LatexCmds.textit=LatexCmds.textsl=makeTextBlock("\\textit","Italic","i",{class:"mq-text-mode"}),LatexCmds.strong=LatexCmds.bold=LatexCmds.textbf=makeTextBlock("\\textbf","Bold","b",{class:"mq-text-mode"}),LatexCmds.sf=LatexCmds.textsf=makeTextBlock("\\textsf","Sans serif font","span",{class:"mq-sans-serif mq-text-mode"}),LatexCmds.tt=LatexCmds.texttt=makeTextBlock("\\texttt","Mono space font","span",{class:"mq-monospace mq-text-mode"}),LatexCmds.textsc=makeTextBlock("\\textsc","Variable font","span",{style:"font-variant:small-caps",class:"mq-text-mode"}),LatexCmds.uppercase=makeTextBlock("\\uppercase","Uppercase","span",{style:"text-transform:uppercase",class:"mq-text-mode"}),LatexCmds.lowercase=makeTextBlock("\\lowercase","Lowercase","span",{style:"text-transform:lowercase",class:"mq-text-mode"});class RootMathCommand extends MathCommand{constructor(e){super("$"),this.domView=new DOMView(1,e=>h.block("span",{class:"mq-math-mode"},e[0])),this.cursor=e}createBlocks(){super.createBlocks();var e=this.getEnd(L);e.cursor=this.cursor,e.write=function(e,t){"$"!==t?MathBlock.prototype.write.call(this,e,t):this.isEmpty()?(e.insRightOf(this.parent),this.parent.deleteTowards(void 0,e),new VanillaSymbol("\\$",h.text("$")).createLeftOf(e.show())):e[R]?e[L]?MathBlock.prototype.write.call(this,e,t):e.insLeftOf(this.parent):e.insRightOf(this.parent)}}latexRecursive(e){this.checkCursorContextOpen(e),e.latex+="$",this.getEnd(L).latexRecursive(e),e.latex+="$",this.checkCursorContextClose(e)}}class RootTextBlock extends RootMathBlock{keystroke(e,t,r){if("Spacebar"!==e&&"Shift-Spacebar"!==e)return super.keystroke(e,t,r)}write(e,t){var r;e.show().deleteSelection(),("$"===t?new RootMathCommand(e):("<"===t?r=h.entityText("&lt;"):">"===t&&(r=h.entityText("&gt;")),new VanillaSymbol(t,r))).createLeftOf(e)}}API.TextField=function(e){e=class extends e.EditableField{__mathquillify(){return super.mathquillify("mq-editable-field mq-text-mode"),this}latex(e){return e?(this.__controller.renderLatexText(e),this.__controller.blurred&&this.__controller.cursor.hide().parent.blur(),this):this.__controller.exportLatex()}};return e.RootBlock=RootTextBlock,e},CharCmds["\\"]=class extends MathCommand{constructor(){super(...arguments),this.ctrlSeq="\\",this.domView=new DOMView(1,e=>h("span",{class:"mq-latex-command-input-wrapper mq-non-leaf"},[h("span",{class:"mq-latex-command-input mq-non-leaf"},[h.text("\\"),h.block("span",{},e[0])])])),this.textTemplate=["\\"]}replaces(e){this._replacedFragment=e.disown(),this.isEmpty=function(){return!1}}createBlocks(){super.createBlocks();var e=this.getEnd(L),s=(e.focus=function(){return this.parent.domFrag().addClass("mq-hasCursor"),this.isEmpty()&&this.parent.domFrag().removeClass("mq-empty"),this},e.blur=function(){return this.parent.domFrag().removeClass("mq-hasCursor"),this.isEmpty()&&this.parent.domFrag().addClass("mq-empty"),this},e.write=function(e,t){var r;e.show().deleteSelection(),t.match(/[a-z]/i)?(new VanillaSymbol(t).createLeftOf(e),e.controller.aria.alert(t)):(r=this.parent.renderCommand(e),e.controller.aria.queue(r.mathspeak({createdLeftOf:e})),"\\"===t&&this.isEmpty()?e.controller.aria.alert():e.parent.write(e,t))},e.keystroke);e.keystroke=function(e,t,r){if("Tab"!==e&&"Enter"!==e&&"Spacebar"!==e)return s.call(this,e,t,r);e=this.parent.renderCommand(r.cursor),r.aria.alert(e.mathspeak({createdLeftOf:r.cursor})),null!=t&&t.preventDefault()}}createLeftOf(e){if(super.createLeftOf(e),this._replacedFragment){e=this.domFrag();const r=e.oneElement();this._replacedFragment.domFrag().addClass("mq-blur");var t=e=>((e.target=r).dispatchEvent(e),!1);r.addEventListener("mousedown",t),r.addEventListener("mouseup",t),this._replacedFragment.domFrag().insertBefore(e.children().first())}}latexRecursive(e){this.checkCursorContextOpen(e),e.latex+="\\",this.getEnd(L).latexRecursive(e),e.latex+=" ",this.checkCursorContextClose(e)}renderCommand(t){var r,s;if(this.setDOM(this.domFrag().children().lastElement()),this.remove(),this[R]?t.insLeftOf(this[R]):t.insAtRightEnd(this.parent),r=this.getEnd(L).latex(),s=LatexCmds[r=r||" "]){let e;return e=isMQNodeClass(s)?new s(r):s(r),this._replacedFragment&&e.replaces(this._replacedFragment),e.createLeftOf(t),e}return(s=new TextBlock).replaces(r),s.createLeftOf(t),t.insRightOf(s),this._replacedFragment&&this._replacedFragment.remove(),s}};
